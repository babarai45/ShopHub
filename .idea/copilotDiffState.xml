<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/ecommerce/views.py">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/ecommerce/views.py" />
              <option name="originalContent" value="from django.shortcuts import render, redirect, get_object_or_404&#10;from django.contrib.auth import authenticate, login, logout&#10;from django.contrib.auth.decorators import login_required&#10;from django.contrib import messages&#10;from django.db.models import Q&#10;from .models import Product, Category, Cart, CartItem, UserProfile&#10;from .forms import CustomUserCreationForm, CustomAuthenticationForm, UserProfileForm&#10;import json&#10;from django.http import JsonResponse&#10;&#10;&#10;def home(request):&#10;    &quot;&quot;&quot;Homepage with featured products&quot;&quot;&quot;&#10;    from .models import TrendingImage&#10;&#10;    featured_products = Product.objects.filter(is_active=True)[:8]&#10;    categories = Category.objects.all()&#10;    trending_images = TrendingImage.objects.filter(is_active=True)&#10;&#10;    context = {&#10;        'featured_products': featured_products,&#10;        'categories': categories,&#10;        'trending_images': trending_images,&#10;        'page_title': 'Home'&#10;    }&#10;    return render(request, 'ecommerce/home.html', context)&#10;&#10;&#10;def product_list(request):&#10;    &quot;&quot;&quot;Display all products with filtering&quot;&quot;&quot;&#10;    products = Product.objects.filter(is_active=True)&#10;    categories = Category.objects.all()&#10;&#10;    # Filter by category&#10;    category_id = request.GET.get('category')&#10;    if category_id:&#10;        products = products.filter(category_id=category_id)&#10;&#10;    # Search&#10;    search_query = request.GET.get('q')&#10;    if search_query:&#10;        products = products.filter(&#10;            Q(name__icontains=search_query) |&#10;            Q(description__icontains=search_query)&#10;        )&#10;&#10;    # Sorting&#10;    sort = request.GET.get('sort', '-created_at')&#10;    products = products.order_by(sort)&#10;&#10;    context = {&#10;        'products': products,&#10;        'categories': categories,&#10;        'search_query': search_query,&#10;        'selected_category': category_id,&#10;        'page_title': 'Products'&#10;    }&#10;    return render(request, 'ecommerce/product_list.html', context)&#10;&#10;&#10;def product_detail(request, slug):&#10;    &quot;&quot;&quot;Display product details&quot;&quot;&quot;&#10;    product = get_object_or_404(Product, slug=slug, is_active=True)&#10;    related_products = Product.objects.filter(&#10;        category=product.category,&#10;        is_active=True&#10;    ).exclude(id=product.id)[:4]&#10;&#10;    context = {&#10;        'product': product,&#10;        'related_products': related_products,&#10;        'page_title': product.name&#10;    }&#10;    return render(request, 'ecommerce/product_detail.html', context)&#10;&#10;&#10;def signup(request):&#10;    &quot;&quot;&quot;User registration&quot;&quot;&quot;&#10;    if request.user.is_authenticated:&#10;        return redirect('ecommerce:home')&#10;&#10;    if request.method == 'POST':&#10;        form = CustomUserCreationForm(request.POST)&#10;        if form.is_valid():&#10;            user = form.save()&#10;            # Create cart for new user (signal should handle this)&#10;            Cart.objects.get_or_create(user=user)&#10;            messages.success(request, 'Account created successfully! Please log in.')&#10;            return redirect('ecommerce:login')&#10;        else:&#10;            for field, errors in form.errors.items():&#10;                for error in errors:&#10;                    messages.error(request, f&quot;{field}: {error}&quot;)&#10;    else:&#10;        form = CustomUserCreationForm()&#10;&#10;    context = {&#10;        'form': form,&#10;        'page_title': 'Sign Up'&#10;    }&#10;    return render(request, 'ecommerce/signup.html', context)&#10;&#10;&#10;def login_view(request):&#10;    &quot;&quot;&quot;User login&quot;&quot;&quot;&#10;    if request.user.is_authenticated:&#10;        return redirect('ecommerce:home')&#10;&#10;    if request.method == 'POST':&#10;        form = CustomAuthenticationForm(request, data=request.POST)&#10;        if form.is_valid():&#10;            username = form.cleaned_data.get('username')&#10;            password = form.cleaned_data.get('password')&#10;            user = authenticate(username=username, password=password)&#10;            if user is not None:&#10;                login(request, user)&#10;                messages.success(request, f'Welcome back, {user.username}!')&#10;                return redirect('ecommerce:home')&#10;    else:&#10;        form = CustomAuthenticationForm()&#10;&#10;    context = {&#10;        'form': form,&#10;        'page_title': 'Login'&#10;    }&#10;    return render(request, 'ecommerce/login.html', context)&#10;&#10;&#10;def logout_view(request):&#10;    &quot;&quot;&quot;User logout&quot;&quot;&quot;&#10;    logout(request)&#10;    messages.success(request, 'You have been logged out successfully.')&#10;    return redirect('ecommerce:home')&#10;&#10;&#10;@login_required(login_url='ecommerce:login')&#10;def profile(request):&#10;    &quot;&quot;&quot;User profile&quot;&quot;&quot;&#10;    from .models import Order, Wishlist&#10;&#10;    user_profile = get_object_or_404(UserProfile, user=request.user)&#10;&#10;    if request.method == 'POST':&#10;        form = UserProfileForm(request.POST, request.FILES, instance=user_profile)&#10;        if form.is_valid():&#10;            form.save()&#10;            messages.success(request, 'Profile updated successfully!')&#10;            return redirect('ecommerce:profile')&#10;    else:&#10;        form = UserProfileForm(instance=user_profile)&#10;&#10;    # Calculate statistics&#10;    total_orders = Order.objects.filter(user=request.user).count()&#10;    completed_orders = Order.objects.filter(user=request.user, status='completed').count()&#10;    pending_orders = Order.objects.filter(user=request.user, status='pending').count()&#10;&#10;    # Get wishlist count&#10;    wishlist_count = 0&#10;    try:&#10;        wishlist = Wishlist.objects.get(user=request.user)&#10;        wishlist_count = wishlist.products.count()&#10;    except Wishlist.DoesNotExist:&#10;        wishlist_count = 0&#10;&#10;    context = {&#10;        'form': form,&#10;        'user_profile': user_profile,&#10;        'page_title': 'My Profile',&#10;        'total_orders': total_orders,&#10;        'completed_orders': completed_orders,&#10;        'pending_orders': pending_orders,&#10;        'wishlist_count': wishlist_count,&#10;    }&#10;    return render(request, 'ecommerce/profile.html', context)&#10;&#10;&#10;@login_required(login_url='ecommerce:login')&#10;def add_to_cart(request, product_id):&#10;    &quot;&quot;&quot;Add product to cart&quot;&quot;&quot;&#10;    product = get_object_or_404(Product, id=product_id)&#10;    cart, created = Cart.objects.get_or_create(user=request.user)&#10;&#10;    quantity = int(request.POST.get('quantity', 1))&#10;&#10;    cart_item, created = CartItem.objects.get_or_create(&#10;        cart=cart,&#10;        product=product,&#10;        defaults={'quantity': quantity}&#10;    )&#10;&#10;    if not created:&#10;        cart_item.quantity += quantity&#10;        cart_item.save()&#10;&#10;    messages.success(request, f'{product.name} added to cart!')&#10;    return redirect('ecommerce:cart')&#10;&#10;&#10;@login_required(login_url='ecommerce:login')&#10;def cart_view(request):&#10;    &quot;&quot;&quot;View shopping cart&quot;&quot;&quot;&#10;    from decimal import Decimal&#10;&#10;    try:&#10;        cart = Cart.objects.get(user=request.user)&#10;    except Cart.DoesNotExist:&#10;        cart = Cart.objects.create(user=request.user)&#10;&#10;    subtotal = Decimal(str(cart.get_total()))&#10;    shipping = Decimal('5.00')&#10;    tax_amount = round((subtotal + shipping) * Decimal('0.1'), 2)&#10;    total_amount = subtotal + shipping + tax_amount&#10;&#10;    context = {&#10;        'cart': cart,&#10;        'subtotal': subtotal,&#10;        'shipping': shipping,&#10;        'tax_amount': tax_amount,&#10;        'total_amount': total_amount,&#10;        'page_title': 'Shopping Cart'&#10;    }&#10;    return render(request, 'ecommerce/cart.html', context)&#10;&#10;&#10;@login_required(login_url='ecommerce:login')&#10;def remove_from_cart(request, cart_item_id):&#10;    &quot;&quot;&quot;Remove item from cart&quot;&quot;&quot;&#10;    cart_item = get_object_or_404(CartItem, id=cart_item_id, cart__user=request.user)&#10;    product_name = cart_item.product.name&#10;    cart_item.delete()&#10;    messages.success(request, f'{product_name} removed from cart!')&#10;    return redirect('ecommerce:cart')&#10;&#10;&#10;@login_required(login_url='ecommerce:login')&#10;def update_cart_item(request, cart_item_id):&#10;    &quot;&quot;&quot;Update cart item quantity&quot;&quot;&quot;&#10;    cart_item = get_object_or_404(CartItem, id=cart_item_id, cart__user=request.user)&#10;    quantity = int(request.POST.get('quantity', 1))&#10;&#10;    if quantity &gt; 0:&#10;        cart_item.quantity = quantity&#10;        cart_item.save()&#10;        messages.success(request, 'Cart updated!')&#10;&#10;    return redirect('ecommerce:cart')&#10;&#10;&#10;@login_required(login_url='ecommerce:login')&#10;def add_to_wishlist(request, product_id):&#10;    &quot;&quot;&quot;Add product to wishlist&quot;&quot;&quot;&#10;    from .models import Wishlist&#10;&#10;    product = get_object_or_404(Product, id=product_id)&#10;&#10;    # Get or create wishlist for user&#10;    wishlist, created = Wishlist.objects.get_or_create(user=request.user)&#10;&#10;    if product in wishlist.products.all():&#10;        wishlist.products.remove(product)&#10;        messages.info(request, f'{product.name} removed from wishlist!')&#10;    else:&#10;        wishlist.products.add(product)&#10;        messages.success(request, f'{product.name} added to wishlist!')&#10;&#10;    return redirect(request.META.get('HTTP_REFERER', 'ecommerce:home'))&#10;&#10;&#10;@login_required(login_url='ecommerce:login')&#10;def remove_from_wishlist(request, product_id):&#10;    &quot;&quot;&quot;Remove product from wishlist&quot;&quot;&quot;&#10;    from .models import Wishlist&#10;&#10;    product = get_object_or_404(Product, id=product_id)&#10;&#10;    try:&#10;        wishlist = Wishlist.objects.get(user=request.user)&#10;        wishlist.products.remove(product)&#10;        messages.success(request, f'{product.name} removed from wishlist!')&#10;    except Wishlist.DoesNotExist:&#10;        messages.error(request, 'Wishlist not found!')&#10;&#10;    return redirect(request.META.get('HTTP_REFERER', 'ecommerce:home'))&#10;&#10;&#10;@login_required(login_url='ecommerce:login')&#10;def share_product(request, product_id):&#10;    &quot;&quot;&quot;Generate shareable link for product&quot;&quot;&quot;&#10;    product = get_object_or_404(Product, id=product_id)&#10;    from django.urls import reverse&#10;    product_url = request.build_absolute_uri(reverse('ecommerce:product_detail', kwargs={'slug': product.slug}))&#10;&#10;    context = {&#10;        'product': product,&#10;        'share_url': product_url,&#10;        'share_text': f'Check out {product.name} on ShopHub!',&#10;    }&#10;    return render(request, 'ecommerce/share_product.html', context)&#10;&#10;&#10;@login_required(login_url='ecommerce:login')&#10;def update_cart_item_ajax(request, cart_item_id):&#10;    &quot;&quot;&quot;Update cart item quantity via AJAX and return updated totals&quot;&quot;&quot;&#10;    if request.method == 'POST' and request.headers.get('X-Requested-With') == 'XMLHttpRequest':&#10;        from decimal import Decimal&#10;&#10;        cart_item = get_object_or_404(CartItem, id=cart_item_id, cart__user=request.user)&#10;        quantity = int(request.POST.get('quantity', 1))&#10;&#10;        # Validate quantity against stock&#10;        if quantity &gt; cart_item.product.stock:&#10;            return JsonResponse({&#10;                'success': False,&#10;                'message': f'Only {cart_item.product.stock} items available in stock!'&#10;            })&#10;&#10;        if quantity &gt; 0:&#10;            cart_item.quantity = quantity&#10;            cart_item.save()&#10;        else:&#10;            return JsonResponse({'success': False, 'message': 'Quantity must be at least 1'})&#10;&#10;        # Calculate new totals&#10;        cart = cart_item.cart&#10;        subtotal = Decimal(str(cart.get_total()))&#10;        shipping = Decimal('5.00')&#10;        tax_amount = round((subtotal + shipping) * Decimal('0.1'), 2)&#10;        total_amount = subtotal + shipping + tax_amount&#10;&#10;        return JsonResponse({&#10;            'success': True,&#10;            'item_total': float(cart_item.get_total()),&#10;            'subtotal': float(subtotal),&#10;            'tax': float(tax_amount),&#10;            'total': float(total_amount),&#10;            'message': 'Cart updated successfully!'&#10;        })&#10;&#10;    return JsonResponse({'success': False, 'message': 'Invalid request'})&#10;&#10;&#10;@login_required(login_url='ecommerce:login')&#10;def wishlist_view(request):&#10;    &quot;&quot;&quot;Display user's wishlist&quot;&quot;&quot;&#10;    from .models import Wishlist&#10;&#10;    try:&#10;        wishlist = Wishlist.objects.get(user=request.user)&#10;        wishlisted_products = wishlist.products.all()&#10;    except Wishlist.DoesNotExist:&#10;        wishlist = Wishlist.objects.create(user=request.user)&#10;        wishlisted_products = wishlist.products.all()&#10;&#10;    context = {&#10;        'wishlisted_products': wishlisted_products,&#10;        'page_title': 'My Wishlist'&#10;    }&#10;    return render(request, 'ecommerce/wishlist.html', context)&#10;&#10;&#10;def about_view(request):&#10;    &quot;&quot;&quot;About page view&quot;&quot;&quot;&#10;    context = {&#10;        'page_title': 'About Us'&#10;    }&#10;    return render(request, 'ecommerce/about.html', context)&#10;&#10;&#10;def blog_view(request):&#10;    &quot;&quot;&quot;Blog page view with published posts&quot;&quot;&quot;&#10;    from .models import BlogPost, BlogCategory&#10;&#10;    posts = BlogPost.objects.filter(is_published=True).order_by('-created_at')&#10;    featured_post = BlogPost.objects.filter(is_published=True, is_featured=True).first()&#10;    categories = BlogCategory.objects.all()&#10;&#10;    # Filter by category&#10;    category_id = request.GET.get('category')&#10;    if category_id:&#10;        posts = posts.filter(category_id=category_id)&#10;&#10;    # Search&#10;    search_query = request.GET.get('q')&#10;    if search_query:&#10;        from django.db.models import Q&#10;        posts = posts.filter(&#10;            Q(title__icontains=search_query) |&#10;            Q(content__icontains=search_query)&#10;        )&#10;&#10;    context = {&#10;        'posts': posts,&#10;        'featured_post': featured_post,&#10;        'categories': categories,&#10;        'search_query': search_query,&#10;        'selected_category': category_id,&#10;        'page_title': 'Blog'&#10;    }&#10;    return render(request, 'ecommerce/blog.html', context)&#10;&#10;&#10;def blog_detail(request, slug):&#10;    &quot;&quot;&quot;Blog post detail view&quot;&quot;&quot;&#10;    from .models import BlogPost&#10;&#10;    post = get_object_or_404(BlogPost, slug=slug, is_published=True)&#10;&#10;    # Increment views&#10;    post.views += 1&#10;    post.save(update_fields=['views'])&#10;&#10;    # Get related posts&#10;    related_posts = BlogPost.objects.filter(&#10;        is_published=True,&#10;        category=post.category&#10;    ).exclude(id=post.id)[:3]&#10;&#10;    context = {&#10;        'post': post,&#10;        'related_posts': related_posts,&#10;        'page_title': post.title&#10;    }&#10;    return render(request, 'ecommerce/blog_detail.html', context)&#10;&#10;&#10;@login_required(login_url='ecommerce:login')&#10;def my_orders(request):&#10;    &quot;&quot;&quot;Display user's orders&quot;&quot;&quot;&#10;    from .models import Order&#10;&#10;    orders = Order.objects.filter(user=request.user).order_by('-created_at')&#10;&#10;    context = {&#10;        'orders': orders,&#10;        'page_title': 'My Orders'&#10;    }&#10;    return render(request, 'ecommerce/my_orders.html', context)&#10;&#10;&#10;@login_required(login_url='ecommerce:login')&#10;def order_detail(request, order_id):&#10;    &quot;&quot;&quot;Display order details&quot;&quot;&quot;&#10;    from .models import Order&#10;&#10;    order = get_object_or_404(Order, id=order_id, user=request.user)&#10;&#10;    context = {&#10;        'order': order,&#10;        'page_title': f'Order #{order.id}'&#10;    }&#10;    return render(request, 'ecommerce/order_detail.html', context)&#10;&#10;&#10;@login_required(login_url='ecommerce:login')&#10;def settings_view(request):&#10;    &quot;&quot;&quot;User settings page&quot;&quot;&quot;&#10;    user_profile = get_object_or_404(UserProfile, user=request.user)&#10;&#10;    if request.method == 'POST':&#10;        form = UserProfileForm(request.POST, request.FILES, instance=user_profile)&#10;        if form.is_valid():&#10;            form.save()&#10;            messages.success(request, 'Settings updated successfully!')&#10;            return redirect('ecommerce:settings')&#10;    else:&#10;        form = UserProfileForm(instance=user_profile)&#10;&#10;    context = {&#10;        'form': form,&#10;        'user_profile': user_profile,&#10;        'page_title': 'Settings'&#10;    }&#10;    return render(request, 'ecommerce/settings.html', context)&#10;&#10;&#10;@login_required(login_url='ecommerce:login')&#10;def checkout(request):&#10;    &quot;&quot;&quot;Checkout page with payment processing&quot;&quot;&quot;&#10;    from decimal import Decimal&#10;    from .models import Order, OrderItem, Cart, Coupon&#10;&#10;    try:&#10;        cart = Cart.objects.get(user=request.user)&#10;    except Cart.DoesNotExist:&#10;        messages.error(request, 'Your cart is empty!')&#10;        return redirect('ecommerce:cart')&#10;&#10;    if not cart.items.exists():&#10;        messages.error(request, 'Your cart is empty!')&#10;        return redirect('ecommerce:cart')&#10;&#10;    user_profile = get_object_or_404(UserProfile, user=request.user)&#10;&#10;    # Get applied coupon from session&#10;    applied_coupon = None&#10;    coupon_discount = Decimal('0.00')&#10;&#10;    if 'applied_coupon' in request.session:&#10;        try:&#10;            applied_coupon = Coupon.objects.get(code=request.session['applied_coupon'])&#10;            if applied_coupon.is_valid():&#10;                subtotal = Decimal(str(cart.get_total()))&#10;                coupon_discount = Decimal(str(applied_coupon.get_discount_amount(subtotal)))&#10;        except Coupon.DoesNotExist:&#10;            del request.session['applied_coupon']&#10;&#10;    if request.method == 'POST':&#10;        # Get form data&#10;        payment_method = request.POST.get('payment_method', 'card')&#10;        shipping_address = request.POST.get('shipping_address', '')&#10;&#10;        # Calculate totals&#10;        subtotal = Decimal(str(cart.get_total()))&#10;        shipping = Decimal('5.00')&#10;        subtotal_with_coupon = subtotal - coupon_discount&#10;        tax_amount = round((subtotal_with_coupon + shipping) * Decimal('0.1'), 2)&#10;        total_amount = subtotal_with_coupon + shipping + tax_amount&#10;&#10;        # Create order&#10;        order = Order.objects.create(&#10;            user=request.user,&#10;            total_amount=total_amount,&#10;            status='pending'&#10;        )&#10;&#10;        # Create order items&#10;        for cart_item in cart.items.all():&#10;            OrderItem.objects.create(&#10;                order=order,&#10;                product=cart_item.product,&#10;                quantity=cart_item.quantity,&#10;                price=cart_item.product.price&#10;            )&#10;            # Update product sold count&#10;            cart_item.product.total_sold += cart_item.quantity&#10;            cart_item.product.save(update_fields=['total_sold'])&#10;&#10;        # Apply coupon if exists&#10;        if applied_coupon:&#10;            applied_coupon.apply()&#10;            del request.session['applied_coupon']&#10;&#10;        # Process payment (dummy integration)&#10;        if payment_method == 'card':&#10;            # Simulate payment processing&#10;            # In production, integrate with Stripe, PayPal, etc.&#10;            order.status = 'completed'&#10;            order.save(update_fields=['status'])&#10;&#10;            # Clear cart&#10;            cart.items.all().delete()&#10;&#10;            messages.success(request, f'Order #{order.id} placed successfully! Payment processed.')&#10;            return redirect('ecommerce:order_detail', order_id=order.id)&#10;        else:&#10;            # Other payment methods (COD, etc.)&#10;            messages.success(request, f'Order #{order.id} placed! Awaiting payment verification.')&#10;            return redirect('ecommerce:order_detail', order_id=order.id)&#10;&#10;    # Calculate totals&#10;    subtotal = Decimal(str(cart.get_total()))&#10;    shipping = Decimal('5.00')&#10;    subtotal_with_coupon = subtotal - coupon_discount&#10;    tax_amount = round((subtotal_with_coupon + shipping) * Decimal('0.1'), 2)&#10;    total_amount = subtotal_with_coupon + shipping + tax_amount&#10;&#10;    context = {&#10;        'cart': cart,&#10;        'user_profile': user_profile,&#10;        'subtotal': subtotal,&#10;        'coupon_discount': coupon_discount,&#10;        'shipping': shipping,&#10;        'tax_amount': tax_amount,&#10;        'total_amount': total_amount,&#10;        'applied_coupon': applied_coupon,&#10;        'page_title': 'Checkout'&#10;    }&#10;    return render(request, 'ecommerce/checkout.html', context)&#10;&#10;&#10;@login_required(login_url='ecommerce:login')&#10;def apply_coupon(request):&#10;    &quot;&quot;&quot;Apply coupon code to cart via AJAX&quot;&quot;&quot;&#10;    from decimal import Decimal&#10;    from .models import Cart, Coupon&#10;&#10;    if request.method == 'POST' and request.headers.get('X-Requested-With') == 'XMLHttpRequest':&#10;        coupon_code = request.POST.get('coupon_code', '').strip().upper()&#10;&#10;        try:&#10;            cart = Cart.objects.get(user=request.user)&#10;        except Cart.DoesNotExist:&#10;            return JsonResponse({&#10;                'success': False,&#10;                'message': 'Cart is empty!'&#10;            })&#10;&#10;        try:&#10;            # Use case-insensitive lookup&#10;            coupon = Coupon.objects.get(code__iexact=coupon_code)&#10;        except Coupon.DoesNotExist:&#10;            return JsonResponse({&#10;                'success': False,&#10;                'message': f'Coupon code &quot;{coupon_code}&quot; not found!'&#10;            })&#10;&#10;        # Check if coupon is valid&#10;        if not coupon.is_valid():&#10;            if coupon.current_uses &gt;= coupon.max_uses:&#10;                return JsonResponse({&#10;                    'success': False,&#10;                    'message': 'This coupon has reached its usage limit!'&#10;                })&#10;            else:&#10;                return JsonResponse({&#10;                    'success': False,&#10;                    'message': 'This coupon is no longer valid!'&#10;                })&#10;&#10;        # Check minimum order amount&#10;        subtotal = Decimal(str(cart.get_total()))&#10;        if subtotal &lt; coupon.min_order_amount:&#10;            return JsonResponse({&#10;                'success': False,&#10;                'message': f'Minimum order amount ${coupon.min_order_amount} required for this coupon!'&#10;            })&#10;&#10;        # Apply coupon - store the actual code from database&#10;        request.session['applied_coupon'] = coupon.code&#10;        coupon_discount = Decimal(str(coupon.get_discount_amount(subtotal)))&#10;&#10;        # Recalculate totals&#10;        subtotal_with_coupon = subtotal - coupon_discount&#10;        shipping = Decimal('5.00')&#10;        tax_amount = round((subtotal_with_coupon + shipping) * Decimal('0.1'), 2)&#10;        total_amount = subtotal_with_coupon + shipping + tax_amount&#10;&#10;        return JsonResponse({&#10;            'success': True,&#10;            'message': f'Coupon &quot;{coupon_code}&quot; applied successfully!',&#10;            'coupon_code': coupon_code,&#10;            'coupon_discount': float(coupon_discount),&#10;            'subtotal': float(subtotal),&#10;            'subtotal_with_coupon': float(subtotal_with_coupon),&#10;            'tax': float(tax_amount),&#10;            'total': float(total_amount)&#10;        })&#10;&#10;    return JsonResponse({'success': False, 'message': 'Invalid request'})&#10;&#10;&#10;@login_required(login_url='ecommerce:login')&#10;def remove_coupon(request):&#10;    &quot;&quot;&quot;Remove applied coupon code&quot;&quot;&quot;&#10;    if request.method == 'POST' and request.headers.get('X-Requested-With') == 'XMLHttpRequest':&#10;        from decimal import Decimal&#10;        from .models import Cart&#10;&#10;        try:&#10;            cart = Cart.objects.get(user=request.user)&#10;        except Cart.DoesNotExist:&#10;            return JsonResponse({&#10;                'success': False,&#10;                'message': 'Cart is empty!'&#10;            })&#10;&#10;        if 'applied_coupon' in request.session:&#10;            del request.session['applied_coupon']&#10;&#10;        # Recalculate totals without coupon&#10;        subtotal = Decimal(str(cart.get_total()))&#10;        shipping = Decimal('5.00')&#10;        tax_amount = round((subtotal + shipping) * Decimal('0.1'), 2)&#10;        total_amount = subtotal + shipping + tax_amount&#10;&#10;        return JsonResponse({&#10;            'success': True,&#10;            'message': 'Coupon removed successfully!',&#10;            'subtotal': float(subtotal),&#10;            'tax': float(tax_amount),&#10;            'total': float(total_amount),&#10;            'coupon_discount': 0.0&#10;        })&#10;&#10;    return JsonResponse({'success': False, 'message': 'Invalid request'})&#10;" />
              <option name="updatedContent" value="from django.shortcuts import render, redirect, get_object_or_404&#10;from django.contrib.auth import authenticate, login, logout&#10;from django.contrib.auth.decorators import login_required&#10;from django.contrib import messages&#10;from django.db.models import Q&#10;from .models import Product, Category, Cart, CartItem, UserProfile&#10;from .forms import CustomUserCreationForm, CustomAuthenticationForm, UserProfileForm&#10;import json&#10;from django.http import JsonResponse&#10;&#10;&#10;def home(request):&#10;    &quot;&quot;&quot;Homepage with featured products&quot;&quot;&quot;&#10;    from .models import TrendingImage&#10;&#10;    featured_products = Product.objects.filter(is_active=True)[:8]&#10;    categories = Category.objects.all()&#10;    trending_images = TrendingImage.objects.filter(is_active=True)&#10;&#10;    context = {&#10;        'featured_products': featured_products,&#10;        'categories': categories,&#10;        'trending_images': trending_images,&#10;        'page_title': 'Home'&#10;    }&#10;    return render(request, 'ecommerce/home.html', context)&#10;&#10;&#10;def product_list(request):&#10;    &quot;&quot;&quot;Display all products with filtering&quot;&quot;&quot;&#10;    products = Product.objects.filter(is_active=True)&#10;    categories = Category.objects.all()&#10;&#10;    # Filter by category&#10;    category_id = request.GET.get('category')&#10;    if category_id:&#10;        products = products.filter(category_id=category_id)&#10;&#10;    # Search&#10;    search_query = request.GET.get('q')&#10;    if search_query:&#10;        products = products.filter(&#10;            Q(name__icontains=search_query) |&#10;            Q(description__icontains=search_query)&#10;        )&#10;&#10;    # Sorting&#10;    sort = request.GET.get('sort', '-created_at')&#10;    products = products.order_by(sort)&#10;&#10;    context = {&#10;        'products': products,&#10;        'categories': categories,&#10;        'search_query': search_query,&#10;        'selected_category': category_id,&#10;        'page_title': 'Products'&#10;    }&#10;    return render(request, 'ecommerce/product_list.html', context)&#10;&#10;&#10;def product_detail(request, slug):&#10;    &quot;&quot;&quot;Display product details&quot;&quot;&quot;&#10;    product = get_object_or_404(Product, slug=slug, is_active=True)&#10;    related_products = Product.objects.filter(&#10;        category=product.category,&#10;        is_active=True&#10;    ).exclude(id=product.id)[:4]&#10;&#10;    context = {&#10;        'product': product,&#10;        'related_products': related_products,&#10;        'page_title': product.name&#10;    }&#10;    return render(request, 'ecommerce/product_detail.html', context)&#10;&#10;&#10;def signup(request):&#10;    &quot;&quot;&quot;User registration&quot;&quot;&quot;&#10;    if request.user.is_authenticated:&#10;        return redirect('ecommerce:home')&#10;&#10;    if request.method == 'POST':&#10;        form = CustomUserCreationForm(request.POST)&#10;        if form.is_valid():&#10;            user = form.save()&#10;            # Create cart for new user (signal should handle this)&#10;            Cart.objects.get_or_create(user=user)&#10;            messages.success(request, 'Account created successfully! Please log in.')&#10;            return redirect('ecommerce:login')&#10;        else:&#10;            for field, errors in form.errors.items():&#10;                for error in errors:&#10;                    messages.error(request, f&quot;{field}: {error}&quot;)&#10;    else:&#10;        form = CustomUserCreationForm()&#10;&#10;    context = {&#10;        'form': form,&#10;        'page_title': 'Sign Up'&#10;    }&#10;    return render(request, 'ecommerce/signup.html', context)&#10;&#10;&#10;def login_view(request):&#10;    &quot;&quot;&quot;User login&quot;&quot;&quot;&#10;    if request.user.is_authenticated:&#10;        return redirect('ecommerce:home')&#10;&#10;    if request.method == 'POST':&#10;        form = CustomAuthenticationForm(request, data=request.POST)&#10;        if form.is_valid():&#10;            username = form.cleaned_data.get('username')&#10;            password = form.cleaned_data.get('password')&#10;            user = authenticate(username=username, password=password)&#10;            if user is not None:&#10;                login(request, user)&#10;                messages.success(request, f'Welcome back, {user.username}!')&#10;                return redirect('ecommerce:home')&#10;    else:&#10;        form = CustomAuthenticationForm()&#10;&#10;    context = {&#10;        'form': form,&#10;        'page_title': 'Login'&#10;    }&#10;    return render(request, 'ecommerce/login.html', context)&#10;&#10;&#10;def logout_view(request):&#10;    &quot;&quot;&quot;User logout&quot;&quot;&quot;&#10;    logout(request)&#10;    messages.success(request, 'You have been logged out successfully.')&#10;    return redirect('ecommerce:home')&#10;&#10;&#10;@login_required(login_url='ecommerce:login')&#10;def profile(request):&#10;    &quot;&quot;&quot;User profile&quot;&quot;&quot;&#10;    from .models import Order, Wishlist&#10;&#10;    user_profile = get_object_or_404(UserProfile, user=request.user)&#10;&#10;    if request.method == 'POST':&#10;        form = UserProfileForm(request.POST, request.FILES, instance=user_profile)&#10;        if form.is_valid():&#10;            form.save()&#10;            messages.success(request, 'Profile updated successfully!')&#10;            return redirect('ecommerce:profile')&#10;    else:&#10;        form = UserProfileForm(instance=user_profile)&#10;&#10;    # Calculate statistics&#10;    total_orders = Order.objects.filter(user=request.user).count()&#10;    completed_orders = Order.objects.filter(user=request.user, status='completed').count()&#10;    pending_orders = Order.objects.filter(user=request.user, status='pending').count()&#10;&#10;    # Get wishlist count&#10;    wishlist_count = 0&#10;    try:&#10;        wishlist = Wishlist.objects.get(user=request.user)&#10;        wishlist_count = wishlist.products.count()&#10;    except Wishlist.DoesNotExist:&#10;        wishlist_count = 0&#10;&#10;    context = {&#10;        'form': form,&#10;        'user_profile': user_profile,&#10;        'page_title': 'My Profile',&#10;        'total_orders': total_orders,&#10;        'completed_orders': completed_orders,&#10;        'pending_orders': pending_orders,&#10;        'wishlist_count': wishlist_count,&#10;    }&#10;    return render(request, 'ecommerce/profile.html', context)&#10;&#10;&#10;@login_required(login_url='ecommerce:login')&#10;def add_to_cart(request, product_id):&#10;    &quot;&quot;&quot;Add product to cart&quot;&quot;&quot;&#10;    product = get_object_or_404(Product, id=product_id)&#10;    cart, created = Cart.objects.get_or_create(user=request.user)&#10;&#10;    quantity = int(request.POST.get('quantity', 1))&#10;&#10;    cart_item, created = CartItem.objects.get_or_create(&#10;        cart=cart,&#10;        product=product,&#10;        defaults={'quantity': quantity}&#10;    )&#10;&#10;    if not created:&#10;        cart_item.quantity += quantity&#10;        cart_item.save()&#10;&#10;    messages.success(request, f'{product.name} added to cart!')&#10;    return redirect('ecommerce:cart')&#10;&#10;&#10;@login_required(login_url='ecommerce:login')&#10;def cart_view(request):&#10;    &quot;&quot;&quot;View shopping cart&quot;&quot;&quot;&#10;    from decimal import Decimal&#10;&#10;    try:&#10;        cart = Cart.objects.get(user=request.user)&#10;    except Cart.DoesNotExist:&#10;        cart = Cart.objects.create(user=request.user)&#10;&#10;    subtotal = Decimal(str(cart.get_total()))&#10;    shipping = Decimal('5.00')&#10;    tax_amount = round((subtotal + shipping) * Decimal('0.1'), 2)&#10;    total_amount = subtotal + shipping + tax_amount&#10;&#10;    context = {&#10;        'cart': cart,&#10;        'subtotal': subtotal,&#10;        'shipping': shipping,&#10;        'tax_amount': tax_amount,&#10;        'total_amount': total_amount,&#10;        'page_title': 'Shopping Cart'&#10;    }&#10;    return render(request, 'ecommerce/cart.html', context)&#10;&#10;&#10;@login_required(login_url='ecommerce:login')&#10;def remove_from_cart(request, cart_item_id):&#10;    &quot;&quot;&quot;Remove item from cart&quot;&quot;&quot;&#10;    cart_item = get_object_or_404(CartItem, id=cart_item_id, cart__user=request.user)&#10;    product_name = cart_item.product.name&#10;    cart_item.delete()&#10;    messages.success(request, f'{product_name} removed from cart!')&#10;    return redirect('ecommerce:cart')&#10;&#10;&#10;@login_required(login_url='ecommerce:login')&#10;def update_cart_item(request, cart_item_id):&#10;    &quot;&quot;&quot;Update cart item quantity&quot;&quot;&quot;&#10;    cart_item = get_object_or_404(CartItem, id=cart_item_id, cart__user=request.user)&#10;    quantity = int(request.POST.get('quantity', 1))&#10;&#10;    if quantity &gt; 0:&#10;        cart_item.quantity = quantity&#10;        cart_item.save()&#10;        messages.success(request, 'Cart updated!')&#10;&#10;    return redirect('ecommerce:cart')&#10;&#10;&#10;@login_required(login_url='ecommerce:login')&#10;def add_to_wishlist(request, product_id):&#10;    &quot;&quot;&quot;Add product to wishlist&quot;&quot;&quot;&#10;    from .models import Wishlist&#10;&#10;    product = get_object_or_404(Product, id=product_id)&#10;&#10;    # Get or create wishlist for user&#10;    wishlist, created = Wishlist.objects.get_or_create(user=request.user)&#10;&#10;    if product in wishlist.products.all():&#10;        wishlist.products.remove(product)&#10;        messages.info(request, f'{product.name} removed from wishlist!')&#10;    else:&#10;        wishlist.products.add(product)&#10;        messages.success(request, f'{product.name} added to wishlist!')&#10;&#10;    return redirect(request.META.get('HTTP_REFERER', 'ecommerce:home'))&#10;&#10;&#10;@login_required(login_url='ecommerce:login')&#10;def remove_from_wishlist(request, product_id):&#10;    &quot;&quot;&quot;Remove product from wishlist&quot;&quot;&quot;&#10;    from .models import Wishlist&#10;&#10;    product = get_object_or_404(Product, id=product_id)&#10;&#10;    try:&#10;        wishlist = Wishlist.objects.get(user=request.user)&#10;        wishlist.products.remove(product)&#10;        messages.success(request, f'{product.name} removed from wishlist!')&#10;    except Wishlist.DoesNotExist:&#10;        messages.error(request, 'Wishlist not found!')&#10;&#10;    return redirect(request.META.get('HTTP_REFERER', 'ecommerce:home'))&#10;&#10;&#10;@login_required(login_url='ecommerce:login')&#10;def share_product(request, product_id):&#10;    &quot;&quot;&quot;Generate shareable link for product&quot;&quot;&quot;&#10;    product = get_object_or_404(Product, id=product_id)&#10;    from django.urls import reverse&#10;    product_url = request.build_absolute_uri(reverse('ecommerce:product_detail', kwargs={'slug': product.slug}))&#10;&#10;    context = {&#10;        'product': product,&#10;        'share_url': product_url,&#10;        'share_text': f'Check out {product.name} on ShopHub!',&#10;    }&#10;    return render(request, 'ecommerce/share_product.html', context)&#10;&#10;&#10;@login_required(login_url='ecommerce:login')&#10;def update_cart_item_ajax(request, cart_item_id):&#10;    &quot;&quot;&quot;Update cart item quantity via AJAX and return updated totals&quot;&quot;&quot;&#10;    if request.method == 'POST' and request.headers.get('X-Requested-With') == 'XMLHttpRequest':&#10;        from decimal import Decimal&#10;&#10;        cart_item = get_object_or_404(CartItem, id=cart_item_id, cart__user=request.user)&#10;        quantity = int(request.POST.get('quantity', 1))&#10;&#10;        # Validate quantity against stock&#10;        if quantity &gt; cart_item.product.stock:&#10;            return JsonResponse({&#10;                'success': False,&#10;                'message': f'Only {cart_item.product.stock} items available in stock!'&#10;            })&#10;&#10;        if quantity &gt; 0:&#10;            cart_item.quantity = quantity&#10;            cart_item.save()&#10;        else:&#10;            return JsonResponse({'success': False, 'message': 'Quantity must be at least 1'})&#10;&#10;        # Calculate new totals&#10;        cart = cart_item.cart&#10;        subtotal = Decimal(str(cart.get_total()))&#10;        shipping = Decimal('5.00')&#10;        tax_amount = round((subtotal + shipping) * Decimal('0.1'), 2)&#10;        total_amount = subtotal + shipping + tax_amount&#10;&#10;        return JsonResponse({&#10;            'success': True,&#10;            'item_total': float(cart_item.get_total()),&#10;            'subtotal': float(subtotal),&#10;            'tax': float(tax_amount),&#10;            'total': float(total_amount),&#10;            'message': 'Cart updated successfully!'&#10;        })&#10;&#10;    return JsonResponse({'success': False, 'message': 'Invalid request'})&#10;&#10;&#10;@login_required(login_url='ecommerce:login')&#10;def wishlist_view(request):&#10;    &quot;&quot;&quot;Display user's wishlist&quot;&quot;&quot;&#10;    from .models import Wishlist&#10;&#10;    try:&#10;        wishlist = Wishlist.objects.get(user=request.user)&#10;        wishlisted_products = wishlist.products.all()&#10;    except Wishlist.DoesNotExist:&#10;        wishlist = Wishlist.objects.create(user=request.user)&#10;        wishlisted_products = wishlist.products.all()&#10;&#10;    context = {&#10;        'wishlisted_products': wishlisted_products,&#10;        'page_title': 'My Wishlist'&#10;    }&#10;    return render(request, 'ecommerce/wishlist.html', context)&#10;&#10;&#10;def about_view(request):&#10;    &quot;&quot;&quot;About page view&quot;&quot;&quot;&#10;    context = {&#10;        'page_title': 'About Us'&#10;    }&#10;    return render(request, 'ecommerce/about.html', context)&#10;&#10;&#10;def blog_view(request):&#10;    &quot;&quot;&quot;Blog page view with published posts&quot;&quot;&quot;&#10;    from .models import BlogPost, BlogCategory&#10;&#10;    posts = BlogPost.objects.filter(is_published=True).order_by('-created_at')&#10;    featured_post = BlogPost.objects.filter(is_published=True, is_featured=True).first()&#10;    categories = BlogCategory.objects.all()&#10;&#10;    # Filter by category&#10;    category_id = request.GET.get('category')&#10;    if category_id:&#10;        posts = posts.filter(category_id=category_id)&#10;&#10;    # Search&#10;    search_query = request.GET.get('q')&#10;    if search_query:&#10;        from django.db.models import Q&#10;        posts = posts.filter(&#10;            Q(title__icontains=search_query) |&#10;            Q(content__icontains=search_query)&#10;        )&#10;&#10;    context = {&#10;        'posts': posts,&#10;        'featured_post': featured_post,&#10;        'categories': categories,&#10;        'search_query': search_query,&#10;        'selected_category': category_id,&#10;        'page_title': 'Blog'&#10;    }&#10;    return render(request, 'ecommerce/blog.html', context)&#10;&#10;&#10;def blog_detail(request, slug):&#10;    &quot;&quot;&quot;Blog post detail view&quot;&quot;&quot;&#10;    from .models import BlogPost&#10;&#10;    post = get_object_or_404(BlogPost, slug=slug, is_published=True)&#10;&#10;    # Increment views&#10;    post.views += 1&#10;    post.save(update_fields=['views'])&#10;&#10;    # Get related posts&#10;    related_posts = BlogPost.objects.filter(&#10;        is_published=True,&#10;        category=post.category&#10;    ).exclude(id=post.id)[:3]&#10;&#10;    context = {&#10;        'post': post,&#10;        'related_posts': related_posts,&#10;        'page_title': post.title&#10;    }&#10;    return render(request, 'ecommerce/blog_detail.html', context)&#10;&#10;&#10;@login_required(login_url='ecommerce:login')&#10;def my_orders(request):&#10;    &quot;&quot;&quot;Display user's orders&quot;&quot;&quot;&#10;    from .models import Order&#10;&#10;    orders = Order.objects.filter(user=request.user).order_by('-created_at')&#10;&#10;    context = {&#10;        'orders': orders,&#10;        'page_title': 'My Orders'&#10;    }&#10;    return render(request, 'ecommerce/my_orders.html', context)&#10;&#10;&#10;@login_required(login_url='ecommerce:login')&#10;def order_detail(request, order_id):&#10;    &quot;&quot;&quot;Display order details&quot;&quot;&quot;&#10;    from .models import Order&#10;&#10;    order = get_object_or_404(Order, id=order_id, user=request.user)&#10;&#10;    context = {&#10;        'order': order,&#10;        'page_title': f'Order #{order.id}'&#10;    }&#10;    return render(request, 'ecommerce/order_detail.html', context)&#10;&#10;&#10;@login_required(login_url='ecommerce:login')&#10;def settings_view(request):&#10;    &quot;&quot;&quot;User settings page&quot;&quot;&quot;&#10;    user_profile = get_object_or_404(UserProfile, user=request.user)&#10;&#10;    if request.method == 'POST':&#10;        form = UserProfileForm(request.POST, request.FILES, instance=user_profile)&#10;        if form.is_valid():&#10;            form.save()&#10;            messages.success(request, 'Settings updated successfully!')&#10;            return redirect('ecommerce:settings')&#10;    else:&#10;        form = UserProfileForm(instance=user_profile)&#10;&#10;    context = {&#10;        'form': form,&#10;        'user_profile': user_profile,&#10;        'page_title': 'Settings'&#10;    }&#10;    return render(request, 'ecommerce/settings.html', context)&#10;&#10;&#10;@login_required(login_url='ecommerce:login')&#10;def checkout(request):&#10;    &quot;&quot;&quot;Checkout page with payment processing&quot;&quot;&quot;&#10;    from decimal import Decimal&#10;    from .models import Order, OrderItem, Cart, Coupon&#10;&#10;    try:&#10;        cart = Cart.objects.get(user=request.user)&#10;    except Cart.DoesNotExist:&#10;        messages.error(request, 'Your cart is empty!')&#10;        return redirect('ecommerce:cart')&#10;&#10;    if not cart.items.exists():&#10;        messages.error(request, 'Your cart is empty!')&#10;        return redirect('ecommerce:cart')&#10;&#10;    user_profile = get_object_or_404(UserProfile, user=request.user)&#10;&#10;    # Get applied coupon from session&#10;    applied_coupon = None&#10;    coupon_discount = Decimal('0.00')&#10;&#10;    if 'applied_coupon' in request.session:&#10;        try:&#10;            applied_coupon = Coupon.objects.get(code__iexact=request.session['applied_coupon'])&#10;            if applied_coupon.is_valid():&#10;                subtotal = Decimal(str(cart.get_total()))&#10;                coupon_discount = Decimal(str(applied_coupon.get_discount_amount(subtotal)))&#10;        except Coupon.DoesNotExist:&#10;            del request.session['applied_coupon']&#10;&#10;    if request.method == 'POST':&#10;        # Get form data&#10;        payment_method = request.POST.get('payment_method', 'card')&#10;        shipping_address = request.POST.get('shipping_address', '')&#10;&#10;        # Calculate totals&#10;        subtotal = Decimal(str(cart.get_total()))&#10;        shipping = Decimal('5.00')&#10;        subtotal_with_coupon = subtotal - coupon_discount&#10;        tax_amount = round((subtotal_with_coupon + shipping) * Decimal('0.1'), 2)&#10;        total_amount = subtotal_with_coupon + shipping + tax_amount&#10;&#10;        # Create order&#10;        order = Order.objects.create(&#10;            user=request.user,&#10;            total_amount=total_amount,&#10;            status='pending'&#10;        )&#10;&#10;        # Create order items&#10;        for cart_item in cart.items.all():&#10;            OrderItem.objects.create(&#10;                order=order,&#10;                product=cart_item.product,&#10;                quantity=cart_item.quantity,&#10;                price=cart_item.product.price&#10;            )&#10;            # Update product sold count&#10;            cart_item.product.total_sold += cart_item.quantity&#10;            cart_item.product.save(update_fields=['total_sold'])&#10;&#10;        # Apply coupon if exists&#10;        if applied_coupon:&#10;            applied_coupon.apply()&#10;            del request.session['applied_coupon']&#10;&#10;        # Process payment (dummy integration)&#10;        if payment_method == 'card':&#10;            # Simulate payment processing&#10;            # In production, integrate with Stripe, PayPal, etc.&#10;            order.status = 'completed'&#10;            order.save(update_fields=['status'])&#10;&#10;            # Clear cart&#10;            cart.items.all().delete()&#10;&#10;            messages.success(request, f'Order #{order.id} placed successfully! Payment processed.')&#10;            return redirect('ecommerce:order_detail', order_id=order.id)&#10;        else:&#10;            # Other payment methods (COD, etc.)&#10;            messages.success(request, f'Order #{order.id} placed! Awaiting payment verification.')&#10;            return redirect('ecommerce:order_detail', order_id=order.id)&#10;&#10;    # Calculate totals&#10;    subtotal = Decimal(str(cart.get_total()))&#10;    shipping = Decimal('5.00')&#10;    subtotal_with_coupon = subtotal - coupon_discount&#10;    tax_amount = round((subtotal_with_coupon + shipping) * Decimal('0.1'), 2)&#10;    total_amount = subtotal_with_coupon + shipping + tax_amount&#10;&#10;    context = {&#10;        'cart': cart,&#10;        'user_profile': user_profile,&#10;        'subtotal': subtotal,&#10;        'coupon_discount': coupon_discount,&#10;        'shipping': shipping,&#10;        'tax_amount': tax_amount,&#10;        'total_amount': total_amount,&#10;        'applied_coupon': applied_coupon,&#10;        'page_title': 'Checkout'&#10;    }&#10;    return render(request, 'ecommerce/checkout.html', context)&#10;&#10;&#10;@login_required(login_url='ecommerce:login')&#10;def apply_coupon(request):&#10;    &quot;&quot;&quot;Apply coupon code to cart via AJAX&quot;&quot;&quot;&#10;    from decimal import Decimal&#10;    from .models import Cart, Coupon&#10;&#10;    if request.method == 'POST' and request.headers.get('X-Requested-With') == 'XMLHttpRequest':&#10;        coupon_code = request.POST.get('coupon_code', '').strip().upper()&#10;&#10;        try:&#10;            cart = Cart.objects.get(user=request.user)&#10;        except Cart.DoesNotExist:&#10;            return JsonResponse({&#10;                'success': False,&#10;                'message': 'Cart is empty!'&#10;            })&#10;&#10;        try:&#10;            # Use case-insensitive lookup&#10;            coupon = Coupon.objects.get(code__iexact=coupon_code)&#10;        except Coupon.DoesNotExist:&#10;            return JsonResponse({&#10;                'success': False,&#10;                'message': f'Coupon code &quot;{coupon_code}&quot; not found!'&#10;            })&#10;&#10;        # Check if coupon is valid&#10;        if not coupon.is_valid():&#10;            if coupon.current_uses &gt;= coupon.max_uses:&#10;                return JsonResponse({&#10;                    'success': False,&#10;                    'message': 'This coupon has reached its usage limit!'&#10;                })&#10;            else:&#10;                return JsonResponse({&#10;                    'success': False,&#10;                    'message': 'This coupon is no longer valid!'&#10;                })&#10;&#10;        # Check minimum order amount&#10;        subtotal = Decimal(str(cart.get_total()))&#10;        if subtotal &lt; coupon.min_order_amount:&#10;            return JsonResponse({&#10;                'success': False,&#10;                'message': f'Minimum order amount ${coupon.min_order_amount} required for this coupon!'&#10;            })&#10;&#10;        # Apply coupon - store the actual code from database&#10;        request.session['applied_coupon'] = coupon.code&#10;        coupon_discount = Decimal(str(coupon.get_discount_amount(subtotal)))&#10;&#10;        # Recalculate totals&#10;        subtotal_with_coupon = subtotal - coupon_discount&#10;        shipping = Decimal('5.00')&#10;        tax_amount = round((subtotal_with_coupon + shipping) * Decimal('0.1'), 2)&#10;        total_amount = subtotal_with_coupon + shipping + tax_amount&#10;&#10;        return JsonResponse({&#10;            'success': True,&#10;            'message': f'Coupon &quot;{coupon_code}&quot; applied successfully!',&#10;            'coupon_code': coupon_code,&#10;            'coupon_discount': float(coupon_discount),&#10;            'subtotal': float(subtotal),&#10;            'subtotal_with_coupon': float(subtotal_with_coupon),&#10;            'tax': float(tax_amount),&#10;            'total': float(total_amount)&#10;        })&#10;&#10;    return JsonResponse({'success': False, 'message': 'Invalid request'})&#10;&#10;&#10;@login_required(login_url='ecommerce:login')&#10;def remove_coupon(request):&#10;    &quot;&quot;&quot;Remove applied coupon code&quot;&quot;&quot;&#10;    if request.method == 'POST' and request.headers.get('X-Requested-With') == 'XMLHttpRequest':&#10;        from decimal import Decimal&#10;        from .models import Cart&#10;&#10;        try:&#10;            cart = Cart.objects.get(user=request.user)&#10;        except Cart.DoesNotExist:&#10;            return JsonResponse({&#10;                'success': False,&#10;                'message': 'Cart is empty!'&#10;            })&#10;&#10;        if 'applied_coupon' in request.session:&#10;            del request.session['applied_coupon']&#10;&#10;        # Recalculate totals without coupon&#10;        subtotal = Decimal(str(cart.get_total()))&#10;        shipping = Decimal('5.00')&#10;        tax_amount = round((subtotal + shipping) * Decimal('0.1'), 2)&#10;        total_amount = subtotal + shipping + tax_amount&#10;&#10;        return JsonResponse({&#10;            'success': True,&#10;            'message': 'Coupon removed successfully!',&#10;            'subtotal': float(subtotal),&#10;            'tax': float(tax_amount),&#10;            'total': float(total_amount),&#10;            'coupon_discount': 0.0&#10;        })&#10;&#10;    return JsonResponse({'success': False, 'message': 'Invalid request'})&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>