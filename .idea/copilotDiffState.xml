<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/ecommerce/views.py">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/ecommerce/views.py" />
              <option name="originalContent" value="from django.shortcuts import render, redirect, get_object_or_404&#10;from django.contrib.auth import authenticate, login, logout&#10;from django.contrib.auth.decorators import login_required&#10;from django.contrib import messages&#10;from django.db.models import Q&#10;from .models import Product, Category, Cart, CartItem, UserProfile, Order, ShippingMethod, TaxRate&#10;from .forms import CustomUserCreationForm, CustomAuthenticationForm, UserProfileForm&#10;import json&#10;from django.http import JsonResponse&#10;&#10;&#10;def home(request):&#10;    &quot;&quot;&quot;Homepage with featured products&quot;&quot;&quot;&#10;    from .models import TrendingImage, Coupon&#10;    from django.utils import timezone&#10;&#10;    featured_products = Product.objects.filter(is_active=True)[:8]&#10;    categories = Category.objects.all()&#10;    trending_images = TrendingImage.objects.filter(is_active=True)&#10;&#10;    # Get featured coupon if available and valid&#10;    now = timezone.now()&#10;    featured_coupon = Coupon.objects.filter(&#10;        is_featured=True,&#10;        is_active=True,&#10;        valid_from__lte=now,&#10;        valid_until__gte=now&#10;    ).first()&#10;&#10;    context = {&#10;        'featured_products': featured_products,&#10;        'categories': categories,&#10;        'trending_images': trending_images,&#10;        'featured_coupon': featured_coupon,&#10;        'page_title': 'Home'&#10;    }&#10;    return render(request, 'ecommerce/home.html', context)&#10;&#10;&#10;def product_list(request):&#10;    &quot;&quot;&quot;Display all products with filtering&quot;&quot;&quot;&#10;    products = Product.objects.filter(is_active=True)&#10;    categories = Category.objects.all()&#10;&#10;    # Filter by category&#10;    category_id = request.GET.get('category')&#10;    if category_id:&#10;        products = products.filter(category_id=category_id)&#10;&#10;    # Search&#10;    search_query = request.GET.get('q')&#10;    if search_query:&#10;        products = products.filter(&#10;            Q(name__icontains=search_query) |&#10;            Q(description__icontains=search_query)&#10;        )&#10;&#10;    # Sorting&#10;    sort = request.GET.get('sort', '-created_at')&#10;    products = products.order_by(sort)&#10;&#10;    context = {&#10;        'products': products,&#10;        'categories': categories,&#10;        'search_query': search_query,&#10;        'selected_category': category_id,&#10;        'page_title': 'Products'&#10;    }&#10;    return render(request, 'ecommerce/product_list.html', context)&#10;&#10;&#10;def product_detail(request, slug):&#10;    &quot;&quot;&quot;Display product details&quot;&quot;&quot;&#10;    product = get_object_or_404(Product, slug=slug, is_active=True)&#10;    related_products = Product.objects.filter(&#10;        category=product.category,&#10;        is_active=True&#10;    ).exclude(id=product.id)[:4]&#10;&#10;    context = {&#10;        'product': product,&#10;        'related_products': related_products,&#10;        'page_title': product.name&#10;    }&#10;    return render(request, 'ecommerce/product_detail.html', context)&#10;&#10;&#10;def signup(request):&#10;    &quot;&quot;&quot;User registration&quot;&quot;&quot;&#10;    if request.user.is_authenticated:&#10;        return redirect('ecommerce:home')&#10;&#10;    if request.method == 'POST':&#10;        form = CustomUserCreationForm(request.POST)&#10;        if form.is_valid():&#10;            user = form.save()&#10;            # Create cart for new user (signal should handle this)&#10;            Cart.objects.get_or_create(user=user)&#10;            messages.success(request, 'Account created successfully! Please log in.')&#10;            return redirect('ecommerce:login')&#10;        else:&#10;            for field, errors in form.errors.items():&#10;                for error in errors:&#10;                    messages.error(request, f&quot;{field}: {error}&quot;)&#10;    else:&#10;        form = CustomUserCreationForm()&#10;&#10;    context = {&#10;        'form': form,&#10;        'page_title': 'Sign Up'&#10;    }&#10;    return render(request, 'ecommerce/signup.html', context)&#10;&#10;&#10;def login_view(request):&#10;    &quot;&quot;&quot;User login&quot;&quot;&quot;&#10;    if request.user.is_authenticated:&#10;        return redirect('ecommerce:home')&#10;&#10;    if request.method == 'POST':&#10;        form = CustomAuthenticationForm(request, data=request.POST)&#10;        if form.is_valid():&#10;            username = form.cleaned_data.get('username')&#10;            password = form.cleaned_data.get('password')&#10;            user = authenticate(username=username, password=password)&#10;            if user is not None:&#10;                login(request, user)&#10;                messages.success(request, f'Welcome back, {user.username}!')&#10;                return redirect('ecommerce:home')&#10;    else:&#10;        form = CustomAuthenticationForm()&#10;&#10;    context = {&#10;        'form': form,&#10;        'page_title': 'Login'&#10;    }&#10;    return render(request, 'ecommerce/login.html', context)&#10;&#10;&#10;def logout_view(request):&#10;    &quot;&quot;&quot;User logout&quot;&quot;&quot;&#10;    logout(request)&#10;    messages.success(request, 'You have been logged out successfully.')&#10;    return redirect('ecommerce:home')&#10;&#10;&#10;@login_required(login_url='ecommerce:login')&#10;def profile(request):&#10;    &quot;&quot;&quot;User profile&quot;&quot;&quot;&#10;    from .models import Order, Wishlist&#10;&#10;    user_profile = get_object_or_404(UserProfile, user=request.user)&#10;&#10;    if request.method == 'POST':&#10;        form = UserProfileForm(request.POST, request.FILES, instance=user_profile)&#10;        if form.is_valid():&#10;            form.save()&#10;            messages.success(request, 'Profile updated successfully!')&#10;            return redirect('ecommerce:profile')&#10;    else:&#10;        form = UserProfileForm(instance=user_profile)&#10;&#10;    # Calculate statistics&#10;    total_orders = Order.objects.filter(user=request.user).count()&#10;    completed_orders = Order.objects.filter(user=request.user, status='completed').count()&#10;    pending_orders = Order.objects.filter(user=request.user, status='pending').count()&#10;&#10;    # Get wishlist count&#10;    wishlist_count = 0&#10;    try:&#10;        wishlist = Wishlist.objects.get(user=request.user)&#10;        wishlist_count = wishlist.products.count()&#10;    except Wishlist.DoesNotExist:&#10;        wishlist_count = 0&#10;&#10;    context = {&#10;        'form': form,&#10;        'user_profile': user_profile,&#10;        'page_title': 'My Profile',&#10;        'total_orders': total_orders,&#10;        'completed_orders': completed_orders,&#10;        'pending_orders': pending_orders,&#10;        'wishlist_count': wishlist_count,&#10;    }&#10;    return render(request, 'ecommerce/profile.html', context)&#10;&#10;&#10;@login_required(login_url='ecommerce:login')&#10;def add_to_cart(request, product_id):&#10;    &quot;&quot;&quot;Add product to cart&quot;&quot;&quot;&#10;    product = get_object_or_404(Product, id=product_id)&#10;    cart, created = Cart.objects.get_or_create(user=request.user)&#10;&#10;    quantity = int(request.POST.get('quantity', 1))&#10;&#10;    # Validate stock&#10;    if quantity &gt; product.stock:&#10;        messages.error(request, f'Only {product.stock} items available in stock!')&#10;        return redirect(request.META.get('HTTP_REFERER', 'ecommerce:home'))&#10;&#10;    if quantity &lt;= 0:&#10;        messages.error(request, 'Quantity must be greater than 0!')&#10;        return redirect(request.META.get('HTTP_REFERER', 'ecommerce:home'))&#10;&#10;    cart_item, created = CartItem.objects.get_or_create(&#10;        cart=cart,&#10;        product=product,&#10;        defaults={'quantity': quantity}&#10;    )&#10;&#10;    if not created:&#10;        # Check if total quantity exceeds stock&#10;        new_quantity = cart_item.quantity + quantity&#10;        if new_quantity &gt; product.stock:&#10;            messages.error(request, f'Only {product.stock - cart_item.quantity} more items can be added!')&#10;            return redirect('ecommerce:cart')&#10;        cart_item.quantity = new_quantity&#10;        cart_item.save()&#10;&#10;    messages.success(request, f'{product.name} added to cart!')&#10;    return redirect('ecommerce:cart')&#10;&#10;&#10;@login_required(login_url='ecommerce:login')&#10;def cart_view(request):&#10;    &quot;&quot;&quot;View shopping cart&quot;&quot;&quot;&#10;    from decimal import Decimal&#10;    from .models import ShippingMethod, TaxRate&#10;&#10;    try:&#10;        cart = Cart.objects.get(user=request.user)&#10;    except Cart.DoesNotExist:&#10;        cart = Cart.objects.create(user=request.user)&#10;&#10;    # Get admin-configured shipping and tax&#10;    # First try to get default tax rate, if not available get any active tax rate&#10;    tax_rate = TaxRate.objects.filter(is_active=True, is_default=True).first()&#10;    if not tax_rate:&#10;        tax_rate = TaxRate.objects.filter(is_active=True).first()&#10;&#10;    shipping_method = ShippingMethod.objects.filter(is_active=True).first()&#10;&#10;    subtotal = Decimal(str(cart.get_total()))&#10;    shipping = Decimal(str(shipping_method.price)) if shipping_method else Decimal('0.00')&#10;&#10;    if tax_rate:&#10;        tax_amount = Decimal(str(tax_rate.calculate_tax(subtotal + shipping)))&#10;    else:&#10;        tax_amount = Decimal('0.00')&#10;&#10;    total_amount = subtotal + shipping + tax_amount&#10;&#10;    context = {&#10;        'cart': cart,&#10;        'subtotal': subtotal,&#10;        'shipping': shipping,&#10;        'shipping_method': shipping_method,&#10;        'tax_amount': tax_amount,&#10;        'tax_rate': tax_rate,&#10;        'total_amount': total_amount,&#10;        'page_title': 'Shopping Cart'&#10;    }&#10;    return render(request, 'ecommerce/cart.html', context)&#10;&#10;&#10;@login_required(login_url='ecommerce:login')&#10;def remove_from_cart(request, cart_item_id):&#10;    &quot;&quot;&quot;Remove item from cart&quot;&quot;&quot;&#10;    cart_item = get_object_or_404(CartItem, id=cart_item_id, cart__user=request.user)&#10;    product_name = cart_item.product.name&#10;    cart_item.delete()&#10;    messages.success(request, f'{product_name} removed from cart!')&#10;    return redirect('ecommerce:cart')&#10;&#10;&#10;@login_required(login_url='ecommerce:login')&#10;def update_cart_item(request, cart_item_id):&#10;    &quot;&quot;&quot;Update cart item quantity&quot;&quot;&quot;&#10;    cart_item = get_object_or_404(CartItem, id=cart_item_id, cart__user=request.user)&#10;    quantity = int(request.POST.get('quantity', 1))&#10;&#10;    # Validate stock&#10;    if quantity &gt; cart_item.product.stock:&#10;        messages.error(request, f'Only {cart_item.product.stock} items available in stock!')&#10;        return redirect('ecommerce:cart')&#10;&#10;    if quantity &lt;= 0:&#10;        messages.error(request, 'Quantity must be greater than 0!')&#10;        return redirect('ecommerce:cart')&#10;&#10;    cart_item.quantity = quantity&#10;    cart_item.save()&#10;    messages.success(request, 'Cart updated!')&#10;&#10;    return redirect('ecommerce:cart')&#10;&#10;&#10;@login_required(login_url='ecommerce:login')&#10;def add_to_wishlist(request, product_id):&#10;    &quot;&quot;&quot;Add product to wishlist&quot;&quot;&quot;&#10;    from .models import Wishlist&#10;&#10;    product = get_object_or_404(Product, id=product_id)&#10;&#10;    # Get or create wishlist for user&#10;    wishlist, created = Wishlist.objects.get_or_create(user=request.user)&#10;&#10;    if product in wishlist.products.all():&#10;        wishlist.products.remove(product)&#10;        messages.info(request, f'{product.name} removed from wishlist!')&#10;    else:&#10;        wishlist.products.add(product)&#10;        messages.success(request, f'{product.name} added to wishlist!')&#10;&#10;    return redirect(request.META.get('HTTP_REFERER', 'ecommerce:home'))&#10;&#10;&#10;@login_required(login_url='ecommerce:login')&#10;def remove_from_wishlist(request, product_id):&#10;    &quot;&quot;&quot;Remove product from wishlist&quot;&quot;&quot;&#10;    from .models import Wishlist&#10;&#10;    product = get_object_or_404(Product, id=product_id)&#10;&#10;    try:&#10;        wishlist = Wishlist.objects.get(user=request.user)&#10;        wishlist.products.remove(product)&#10;        messages.success(request, f'{product.name} removed from wishlist!')&#10;    except Wishlist.DoesNotExist:&#10;        messages.error(request, 'Wishlist not found!')&#10;&#10;    return redirect(request.META.get('HTTP_REFERER', 'ecommerce:home'))&#10;&#10;&#10;@login_required(login_url='ecommerce:login')&#10;def share_product(request, product_id):&#10;    &quot;&quot;&quot;Generate shareable link for product&quot;&quot;&quot;&#10;    product = get_object_or_404(Product, id=product_id)&#10;    from django.urls import reverse&#10;    product_url = request.build_absolute_uri(reverse('ecommerce:product_detail', kwargs={'slug': product.slug}))&#10;&#10;    context = {&#10;        'product': product,&#10;        'share_url': product_url,&#10;        'share_text': f'Check out {product.name} on Order2Wear!',&#10;    }&#10;    return render(request, 'ecommerce/share_product.html', context)&#10;&#10;&#10;@login_required(login_url='ecommerce:login')&#10;def update_cart_item_ajax(request, cart_item_id):&#10;    &quot;&quot;&quot;Update cart item quantity via AJAX and return updated totals&quot;&quot;&quot;&#10;    if request.method == 'POST' and request.headers.get('X-Requested-With') == 'XMLHttpRequest':&#10;        from decimal import Decimal&#10;&#10;        cart_item = get_object_or_404(CartItem, id=cart_item_id, cart__user=request.user)&#10;        quantity = int(request.POST.get('quantity', 1))&#10;&#10;        # Validate quantity against stock&#10;        if quantity &gt; cart_item.product.stock:&#10;            return JsonResponse({&#10;                'success': False,&#10;                'message': f'Only {cart_item.product.stock} items available in stock!'&#10;            })&#10;&#10;        if quantity &gt; 0:&#10;            cart_item.quantity = quantity&#10;            cart_item.save()&#10;        else:&#10;            return JsonResponse({'success': False, 'message': 'Quantity must be at least 1'})&#10;&#10;        # Calculate new totals&#10;        from .models import ShippingMethod, TaxRate&#10;&#10;        cart = cart_item.cart&#10;        shipping_method = ShippingMethod.objects.filter(is_active=True).first()&#10;        # First try to get default tax rate, if not available get any active tax rate&#10;        tax_rate = TaxRate.objects.filter(is_active=True, is_default=True).first()&#10;        if not tax_rate:&#10;            tax_rate = TaxRate.objects.filter(is_active=True).first()&#10;&#10;        subtotal = Decimal(str(cart.get_total()))&#10;        shipping = Decimal(str(shipping_method.price)) if shipping_method else Decimal('0.00')&#10;&#10;        if tax_rate:&#10;            tax_amount = Decimal(str(tax_rate.calculate_tax(subtotal + shipping)))&#10;        else:&#10;            tax_amount = Decimal('0.00')&#10;&#10;        total_amount = subtotal + shipping + tax_amount&#10;&#10;        return JsonResponse({&#10;            'success': True,&#10;            'item_total': float(cart_item.get_total()),&#10;            'subtotal': float(subtotal),&#10;            'tax': float(tax_amount),&#10;            'total': float(total_amount),&#10;            'message': 'Cart updated successfully!'&#10;        })&#10;&#10;    return JsonResponse({'success': False, 'message': 'Invalid request'})&#10;&#10;&#10;@login_required(login_url='ecommerce:login')&#10;def wishlist_view(request):&#10;    &quot;&quot;&quot;Display user's wishlist&quot;&quot;&quot;&#10;    from .models import Wishlist&#10;&#10;    try:&#10;        wishlist = Wishlist.objects.get(user=request.user)&#10;        wishlisted_products = wishlist.products.all()&#10;    except Wishlist.DoesNotExist:&#10;        wishlist = Wishlist.objects.create(user=request.user)&#10;        wishlisted_products = wishlist.products.all()&#10;&#10;    context = {&#10;        'wishlisted_products': wishlisted_products,&#10;        'page_title': 'My Wishlist'&#10;    }&#10;    return render(request, 'ecommerce/wishlist.html', context)&#10;&#10;&#10;def about_view(request):&#10;    &quot;&quot;&quot;About page view&quot;&quot;&quot;&#10;    context = {&#10;        'page_title': 'About Us'&#10;    }&#10;    return render(request, 'ecommerce/about.html', context)&#10;&#10;&#10;def blog_view(request):&#10;    &quot;&quot;&quot;Blog page view with published posts&quot;&quot;&quot;&#10;    from .models import BlogPost, BlogCategory&#10;&#10;    posts = BlogPost.objects.filter(is_published=True).order_by('-created_at')&#10;    featured_post = BlogPost.objects.filter(is_published=True, is_featured=True).first()&#10;    categories = BlogCategory.objects.all()&#10;&#10;    # Filter by category&#10;    category_id = request.GET.get('category')&#10;    if category_id:&#10;        posts = posts.filter(category_id=category_id)&#10;&#10;    # Search&#10;    search_query = request.GET.get('q')&#10;    if search_query:&#10;        from django.db.models import Q&#10;        posts = posts.filter(&#10;            Q(title__icontains=search_query) |&#10;            Q(content__icontains=search_query)&#10;        )&#10;&#10;    context = {&#10;        'posts': posts,&#10;        'featured_post': featured_post,&#10;        'categories': categories,&#10;        'search_query': search_query,&#10;        'selected_category': category_id,&#10;        'page_title': 'Blog'&#10;    }&#10;    return render(request, 'ecommerce/blog.html', context)&#10;&#10;&#10;def blog_detail(request, slug):&#10;    &quot;&quot;&quot;Blog post detail view&quot;&quot;&quot;&#10;    from .models import BlogPost&#10;&#10;    post = get_object_or_404(BlogPost, slug=slug, is_published=True)&#10;&#10;    # Increment views&#10;    post.views += 1&#10;    post.save(update_fields=['views'])&#10;&#10;    # Get related posts&#10;    related_posts = BlogPost.objects.filter(&#10;        is_published=True,&#10;        category=post.category&#10;    ).exclude(id=post.id)[:3]&#10;&#10;    context = {&#10;        'post': post,&#10;        'related_posts': related_posts,&#10;        'page_title': post.title&#10;    }&#10;    return render(request, 'ecommerce/blog_detail.html', context)&#10;&#10;&#10;@login_required(login_url='ecommerce:login')&#10;def my_orders(request):&#10;    &quot;&quot;&quot;Display user's orders&quot;&quot;&quot;&#10;    from .models import Order&#10;&#10;    orders = Order.objects.filter(user=request.user).order_by('-created_at')&#10;&#10;    context = {&#10;        'orders': orders,&#10;        'page_title': 'My Orders'&#10;    }&#10;    return render(request, 'ecommerce/my_orders.html', context)&#10;&#10;&#10;@login_required(login_url='ecommerce:login')&#10;def order_detail(request, order_id):&#10;    &quot;&quot;&quot;Display order details&quot;&quot;&quot;&#10;    from .models import Order&#10;&#10;    order = get_object_or_404(Order, id=order_id, user=request.user)&#10;&#10;    context = {&#10;        'order': order,&#10;        'page_title': f'Order #{order.id}'&#10;    }&#10;    return render(request, 'ecommerce/order_detail.html', context)&#10;&#10;&#10;@login_required(login_url='ecommerce:login')&#10;def settings_view(request):&#10;    &quot;&quot;&quot;User settings page&quot;&quot;&quot;&#10;    user_profile = get_object_or_404(UserProfile, user=request.user)&#10;&#10;    if request.method == 'POST':&#10;        form = UserProfileForm(request.POST, request.FILES, instance=user_profile)&#10;        if form.is_valid():&#10;            form.save()&#10;            messages.success(request, 'Settings updated successfully!')&#10;            return redirect('ecommerce:settings')&#10;    else:&#10;        form = UserProfileForm(instance=user_profile)&#10;&#10;    context = {&#10;        'form': form,&#10;        'user_profile': user_profile,&#10;        'page_title': 'Settings'&#10;    }&#10;    return render(request, 'ecommerce/settings.html', context)&#10;&#10;&#10;@login_required(login_url='ecommerce:login')&#10;def checkout(request):&#10;    &quot;&quot;&quot;Checkout page with payment processing&quot;&quot;&quot;&#10;    from decimal import Decimal&#10;    from .models import Order, OrderItem, Cart, Coupon&#10;&#10;    try:&#10;        cart = Cart.objects.get(user=request.user)&#10;    except Cart.DoesNotExist:&#10;        messages.error(request, 'Your cart is empty!')&#10;        return redirect('ecommerce:cart')&#10;&#10;    if not cart.items.exists():&#10;        messages.error(request, 'Your cart is empty!')&#10;        return redirect('ecommerce:cart')&#10;&#10;    user_profile = get_object_or_404(UserProfile, user=request.user)&#10;&#10;    # Get applied coupon from session&#10;    applied_coupon = None&#10;    coupon_discount = Decimal('0.00')&#10;&#10;    if 'applied_coupon' in request.session:&#10;        try:&#10;            applied_coupon = Coupon.objects.get(code__iexact=request.session['applied_coupon'])&#10;            if applied_coupon.is_valid():&#10;                subtotal = Decimal(str(cart.get_total()))&#10;                coupon_discount = Decimal(str(applied_coupon.get_discount_amount(subtotal)))&#10;        except Coupon.DoesNotExist:&#10;            del request.session['applied_coupon']&#10;&#10;    if request.method == 'POST':&#10;        # Get form data for shipping information&#10;        first_name = request.POST.get('first_name', '').strip()&#10;        last_name = request.POST.get('last_name', '').strip()&#10;        email = request.POST.get('email', '').strip()&#10;        phone = request.POST.get('phone', '').strip()&#10;        shipping_address = request.POST.get('shipping_address', '').strip()&#10;        city = request.POST.get('city', '').strip()&#10;        state = request.POST.get('state', '').strip()&#10;        postal_code = request.POST.get('postal_code', '').strip()&#10;        country = request.POST.get('country', '').strip()&#10;        payment_method = request.POST.get('payment_method', 'cod')&#10;&#10;        # Validate required fields&#10;        if not all([first_name, last_name, email, phone, shipping_address, city, state, postal_code, country]):&#10;            messages.error(request, 'Please fill in all required shipping information fields.')&#10;            return redirect('ecommerce:checkout')&#10;&#10;        # Get admin-configured shipping and tax&#10;        from .models import ShippingMethod, TaxRate&#10;        shipping_method = ShippingMethod.objects.filter(is_active=True).first()&#10;        # First try to get default tax rate, if not available get any active tax rate&#10;        tax_rate = TaxRate.objects.filter(is_active=True, is_default=True).first()&#10;        if not tax_rate:&#10;            tax_rate = TaxRate.objects.filter(is_active=True).first()&#10;&#10;        # Calculate totals&#10;        subtotal = Decimal(str(cart.get_total()))&#10;        shipping = Decimal(str(shipping_method.price)) if shipping_method else Decimal('0.00')&#10;        subtotal_with_coupon = subtotal - coupon_discount&#10;&#10;        if tax_rate:&#10;            tax_amount = Decimal(str(tax_rate.calculate_tax(subtotal_with_coupon + shipping)))&#10;        else:&#10;            tax_amount = Decimal('0.00')&#10;&#10;        total_amount = subtotal_with_coupon + shipping + tax_amount&#10;&#10;        # Create order with shipping information and references to shipping and tax&#10;        order = Order.objects.create(&#10;            user=request.user,&#10;            shipping_method=shipping_method,&#10;            tax_rate=tax_rate,&#10;            subtotal=subtotal,&#10;            shipping_cost=shipping,&#10;            tax_amount=tax_amount,&#10;            total_amount=total_amount,&#10;            status='pending'&#10;        )&#10;&#10;        # Create order items&#10;        for cart_item in cart.items.all():&#10;            OrderItem.objects.create(&#10;                order=order,&#10;                product=cart_item.product,&#10;                quantity=cart_item.quantity,&#10;                price=cart_item.product.price&#10;            )&#10;            # Update product sold count&#10;            cart_item.product.total_sold += cart_item.quantity&#10;            cart_item.product.save(update_fields=['total_sold'])&#10;&#10;        # Apply coupon if exists&#10;        if applied_coupon:&#10;            applied_coupon.apply()&#10;            del request.session['applied_coupon']&#10;&#10;        # Process payment&#10;        if payment_method == 'card':&#10;            # Credit card (currently disabled in frontend)&#10;            order.status = 'completed'&#10;            order.save(update_fields=['status'])&#10;            cart.items.all().delete()&#10;            messages.success(request, f'Order #{order.id} placed successfully! Payment processed.')&#10;            return redirect('ecommerce:order_detail', order_id=order.id)&#10;        elif payment_method == 'cod':&#10;            # Cash on Delivery&#10;            order.status = 'pending'&#10;            order.save(update_fields=['status'])&#10;            cart.items.all().delete()&#10;            messages.success(request, f'Order #{order.id} placed! We will contact you for payment confirmation.')&#10;            return redirect('ecommerce:order_detail', order_id=order.id)&#10;        elif payment_method == 'bank_transfer':&#10;            # Bank Transfer&#10;            order.status = 'pending'&#10;            order.save(update_fields=['status'])&#10;            cart.items.all().delete()&#10;            messages.success(request, f'Order #{order.id} placed! Please transfer payment to complete the order.')&#10;            return redirect('ecommerce:order_detail', order_id=order.id)&#10;        else:&#10;            # Digital wallet (currently disabled in frontend)&#10;            order.status = 'pending'&#10;            order.save(update_fields=['status'])&#10;            cart.items.all().delete()&#10;            messages.success(request, f'Order #{order.id} placed! Awaiting payment verification.')&#10;            return redirect('ecommerce:order_detail', order_id=order.id)&#10;&#10;    # Get admin-configured shipping and tax&#10;    from .models import ShippingMethod, TaxRate&#10;    shipping_method = ShippingMethod.objects.filter(is_active=True).first()&#10;    # First try to get default tax rate, if not available get any active tax rate&#10;    tax_rate = TaxRate.objects.filter(is_active=True, is_default=True).first()&#10;    if not tax_rate:&#10;        tax_rate = TaxRate.objects.filter(is_active=True).first()&#10;&#10;    # Calculate totals&#10;    subtotal = Decimal(str(cart.get_total()))&#10;    shipping = Decimal(str(shipping_method.price)) if shipping_method else Decimal('0.00')&#10;    subtotal_with_coupon = subtotal - coupon_discount&#10;&#10;    if tax_rate:&#10;        tax_amount = Decimal(str(tax_rate.calculate_tax(subtotal_with_coupon + shipping)))&#10;    else:&#10;        tax_amount = Decimal('0.00')&#10;&#10;    total_amount = subtotal_with_coupon + shipping + tax_amount&#10;&#10;    context = {&#10;        'cart': cart,&#10;        'user_profile': user_profile,&#10;        'subtotal': subtotal,&#10;        'coupon_discount': coupon_discount,&#10;        'shipping': shipping,&#10;        'shipping_method': shipping_method,&#10;        'tax_amount': tax_amount,&#10;        'tax_rate': tax_rate,&#10;        'total_amount': total_amount,&#10;        'applied_coupon': applied_coupon,&#10;        'page_title': 'Checkout'&#10;    }&#10;    return render(request, 'ecommerce/checkout.html', context)&#10;&#10;&#10;@login_required(login_url='ecommerce:login')&#10;def apply_coupon(request):&#10;    &quot;&quot;&quot;Apply coupon code to cart via AJAX&quot;&quot;&quot;&#10;    from decimal import Decimal&#10;    from .models import Cart, Coupon&#10;&#10;    if request.method == 'POST' and request.headers.get('X-Requested-With') == 'XMLHttpRequest':&#10;        coupon_code = request.POST.get('coupon_code', '').strip().upper()&#10;&#10;        try:&#10;            cart = Cart.objects.get(user=request.user)&#10;        except Cart.DoesNotExist:&#10;            return JsonResponse({&#10;                'success': False,&#10;                'message': 'Cart is empty!'&#10;            })&#10;&#10;        try:&#10;            # Use case-insensitive lookup&#10;            coupon = Coupon.objects.get(code__iexact=coupon_code)&#10;        except Coupon.DoesNotExist:&#10;            return JsonResponse({&#10;                'success': False,&#10;                'message': f'Coupon code &quot;{coupon_code}&quot; not found!'&#10;            })&#10;&#10;        # Check if coupon is valid&#10;        if not coupon.is_valid():&#10;            if coupon.current_uses &gt;= coupon.max_uses:&#10;                return JsonResponse({&#10;                    'success': False,&#10;                    'message': 'This coupon has reached its usage limit!'&#10;                })&#10;            else:&#10;                return JsonResponse({&#10;                    'success': False,&#10;                    'message': 'This coupon is no longer valid!'&#10;                })&#10;&#10;        # Check minimum order amount&#10;        subtotal = Decimal(str(cart.get_total()))&#10;        if subtotal &lt; coupon.min_order_amount:&#10;            return JsonResponse({&#10;                'success': False,&#10;                'message': f'Minimum order amount ${coupon.min_order_amount} required for this coupon!'&#10;            })&#10;&#10;        # Apply coupon - store the actual code from database&#10;        request.session['applied_coupon'] = coupon.code&#10;        coupon_discount = Decimal(str(coupon.get_discount_amount(subtotal)))&#10;&#10;        # Get admin-configured shipping and tax&#10;        from .models import ShippingMethod, TaxRate&#10;        shipping_method = ShippingMethod.objects.filter(is_active=True).first()&#10;        # First try to get default tax rate, if not available get any active tax rate&#10;        tax_rate = TaxRate.objects.filter(is_active=True, is_default=True).first()&#10;        if not tax_rate:&#10;            tax_rate = TaxRate.objects.filter(is_active=True).first()&#10;&#10;        # Recalculate totals&#10;        subtotal_with_coupon = subtotal - coupon_discount&#10;        shipping = Decimal(str(shipping_method.price)) if shipping_method else Decimal('0.00')&#10;&#10;        if tax_rate:&#10;            tax_amount = Decimal(str(tax_rate.calculate_tax(subtotal_with_coupon + shipping)))&#10;        else:&#10;            tax_amount = Decimal('0.00')&#10;&#10;        total_amount = subtotal_with_coupon + shipping + tax_amount&#10;&#10;        return JsonResponse({&#10;            'success': True,&#10;            'message': f'Coupon &quot;{coupon_code}&quot; applied successfully!',&#10;            'coupon_code': coupon_code,&#10;            'coupon_discount': float(coupon_discount),&#10;            'subtotal': float(subtotal),&#10;            'subtotal_with_coupon': float(subtotal_with_coupon),&#10;            'tax': float(tax_amount),&#10;            'total': float(total_amount)&#10;        })&#10;&#10;    return JsonResponse({'success': False, 'message': 'Invalid request'})&#10;&#10;&#10;@login_required(login_url='ecommerce:login')&#10;def remove_coupon(request):&#10;    &quot;&quot;&quot;Remove applied coupon code&quot;&quot;&quot;&#10;    if request.method == 'POST' and request.headers.get('X-Requested-With') == 'XMLHttpRequest':&#10;        from decimal import Decimal&#10;        from .models import Cart&#10;&#10;        try:&#10;            cart = Cart.objects.get(user=request.user)&#10;        except Cart.DoesNotExist:&#10;            return JsonResponse({&#10;                'success': False,&#10;                'message': 'Cart is empty!'&#10;            })&#10;&#10;        if 'applied_coupon' in request.session:&#10;            del request.session['applied_coupon']&#10;&#10;        # Get admin-configured shipping and tax&#10;        from .models import ShippingMethod, TaxRate&#10;        shipping_method = ShippingMethod.objects.filter(is_active=True).first()&#10;        # First try to get default tax rate, if not available get any active tax rate&#10;        tax_rate = TaxRate.objects.filter(is_active=True, is_default=True).first()&#10;        if not tax_rate:&#10;            tax_rate = TaxRate.objects.filter(is_active=True).first()&#10;&#10;        # Recalculate totals without coupon using admin config&#10;        subtotal = Decimal(str(cart.get_total()))&#10;        shipping = Decimal(str(shipping_method.price)) if shipping_method else Decimal('0.00')&#10;&#10;        if tax_rate:&#10;            tax_amount = Decimal(str(tax_rate.calculate_tax(subtotal + shipping)))&#10;        else:&#10;            tax_amount = Decimal('0.00')&#10;&#10;        total_amount = subtotal + shipping + tax_amount&#10;&#10;        return JsonResponse({&#10;            'success': True,&#10;            'message': 'Coupon removed successfully!',&#10;            'subtotal': float(subtotal),&#10;            'tax': float(tax_amount),&#10;            'total': float(total_amount),&#10;            'coupon_discount': 0.0&#10;        })&#10;&#10;    return JsonResponse({'success': False, 'message': 'Invalid request'})&#10;&#10;&#10;@login_required(login_url='ecommerce:login')&#10;def download_invoice(request, order_id):&#10;    &quot;&quot;&quot;Download order invoice as PDF with professional formatting&quot;&quot;&quot;&#10;    from django.http import HttpResponse&#10;    from reportlab.lib.pagesizes import letter&#10;    from reportlab.platypus import SimpleDocTemplate, Table, TableStyle, Paragraph, Spacer&#10;    from reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle&#10;    from reportlab.lib.units import inch&#10;    from reportlab.lib import colors&#10;    from io import BytesIO&#10;&#10;    order = get_object_or_404(Order, id=order_id, user=request.user)&#10;&#10;    # Create PDF in memory&#10;    buffer = BytesIO()&#10;    doc = SimpleDocTemplate(buffer, pagesize=letter, rightMargin=0.5*inch, leftMargin=0.5*inch,&#10;                          topMargin=0.5*inch, bottomMargin=0.5*inch)&#10;&#10;    elements = []&#10;    styles = getSampleStyleSheet()&#10;&#10;    # Custom styles&#10;    title_style = ParagraphStyle(&#10;        'CustomTitle',&#10;        parent=styles['Heading1'],&#10;        fontSize=24,&#10;        textColor=colors.HexColor('#667eea'),&#10;        spaceAfter=6,&#10;        alignment=1&#10;    )&#10;&#10;    heading_style = ParagraphStyle(&#10;        'CustomHeading',&#10;        parent=styles['Heading2'],&#10;        fontSize=14,&#10;        textColor=colors.HexColor('#667eea'),&#10;        spaceAfter=12,&#10;        spaceBefore=12&#10;    )&#10;&#10;    # Title&#10;    elements.append(Paragraph(&quot;️ Order2Wear Invoice&quot;, title_style))&#10;    elements.append(Spacer(1, 0.2*inch))&#10;&#10;    # Invoice header info&#10;    header_data = [&#10;        ['Invoice #', f'{order.id}', 'Date', order.created_at.strftime('%B %d, %Y')],&#10;        ['Status', order.get_status_display(), 'Order Time', order.created_at.strftime('%I:%M %p')],&#10;    ]&#10;&#10;    header_table = Table(header_data, colWidths=[1.5*inch, 1.5*inch, 1.5*inch, 1.5*inch])&#10;    header_table.setStyle(TableStyle([&#10;        ('BACKGROUND', (0, 0), (-1, -1), colors.HexColor('#f0f0f0')),&#10;        ('TEXTCOLOR', (0, 0), (-1, -1), colors.black),&#10;        ('ALIGN', (0, 0), (-1, -1), 'LEFT'),&#10;        ('FONTNAME', (0, 0), (-1, -1), 'Helvetica-Bold'),&#10;        ('FONTSIZE', (0, 0), (-1, -1), 10),&#10;        ('BOTTOMPADDING', (0, 0), (-1, -1), 8),&#10;        ('GRID', (0, 0), (-1, -1), 1, colors.black)&#10;    ]))&#10;    elements.append(header_table)&#10;    elements.append(Spacer(1, 0.2*inch))&#10;&#10;    # Customer info&#10;    elements.append(Paragraph(&quot;Customer Information&quot;, heading_style))&#10;    customer_data = [&#10;        ['Name', order.user.get_full_name() or order.user.username],&#10;        ['Email', order.user.email],&#10;    ]&#10;&#10;    customer_table = Table(customer_data, colWidths=[1.5*inch, 5*inch])&#10;    customer_table.setStyle(TableStyle([&#10;        ('BACKGROUND', (0, 0), (0, -1), colors.HexColor('#667eea')),&#10;        ('TEXTCOLOR', (0, 0), (0, -1), colors.white),&#10;        ('ALIGN', (0, 0), (-1, -1), 'LEFT'),&#10;        ('FONTNAME', (0, 0), (0, -1), 'Helvetica-Bold'),&#10;        ('FONTSIZE', (0, 0), (-1, -1), 10),&#10;        ('BOTTOMPADDING', (0, 0), (-1, -1), 8),&#10;        ('GRID', (0, 0), (-1, -1), 1, colors.black)&#10;    ]))&#10;    elements.append(customer_table)&#10;    elements.append(Spacer(1, 0.2*inch))&#10;&#10;    # Order items&#10;    elements.append(Paragraph(&quot;Order Items&quot;, heading_style))&#10;&#10;    items_data = [['Product', 'Quantity', 'Unit Price', 'Total']]&#10;&#10;    for item in order.items.all():&#10;        items_data.append([&#10;            item.product.name[:40],&#10;            str(item.quantity),&#10;            f'₨{item.price:.2f}',&#10;            f'₨{item.price * item.quantity:.2f}'&#10;        ])&#10;&#10;    items_table = Table(items_data, colWidths=[2.5*inch, 1*inch, 1.5*inch, 1.5*inch])&#10;    items_table.setStyle(TableStyle([&#10;        ('BACKGROUND', (0, 0), (-1, 0), colors.HexColor('#667eea')),&#10;        ('TEXTCOLOR', (0, 0), (-1, 0), colors.white),&#10;        ('ALIGN', (0, 0), (-1, -1), 'CENTER'),&#10;        ('ALIGN', (0, 0), (0, -1), 'LEFT'),&#10;        ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),&#10;        ('FONTSIZE', (0, 0), (-1, -1), 9),&#10;        ('BOTTOMPADDING', (0, 0), (-1, 0), 10),&#10;        ('GRID', (0, 0), (-1, -1), 1, colors.black),&#10;        ('ROWBACKGROUNDS', (0, 1), (-1, -1), [colors.white, colors.HexColor('#f9f9f9')])&#10;    ]))&#10;    elements.append(items_table)&#10;    elements.append(Spacer(1, 0.2*inch))&#10;&#10;    # Order summary&#10;    elements.append(Paragraph(&quot;Order Summary&quot;, heading_style))&#10;&#10;    summary_data = [&#10;        ['Subtotal', '', f'₨{order.subtotal:.2f}'],&#10;        ['Shipping', f'({order.shipping_method.name if order.shipping_method else &quot;N/A&quot;})', f'₨{order.shipping_cost:.2f}'],&#10;        ['Tax', f'({order.tax_rate.name if order.tax_rate else &quot;N/A&quot;})', f'₨{order.tax_amount:.2f}'],&#10;        ['', '', ''],&#10;        ['TOTAL', '', f'₨{order.total_amount:.2f}'],&#10;    ]&#10;&#10;    summary_table = Table(summary_data, colWidths=[3*inch, 1.5*inch, 1.5*inch])&#10;    summary_table.setStyle(TableStyle([&#10;        ('ALIGN', (0, 0), (-1, -1), 'RIGHT'),&#10;        ('ALIGN', (0, 0), (0, -1), 'LEFT'),&#10;        ('FONTNAME', (0, 0), (-1, 3), 'Helvetica'),&#10;        ('FONTNAME', (0, 4), (-1, 4), 'Helvetica-Bold'),&#10;        ('FONTSIZE', (0, 4), (-1, 4), 12),&#10;        ('BACKGROUND', (0, 4), (-1, 4), colors.HexColor('#667eea')),&#10;        ('TEXTCOLOR', (0, 4), (-1, 4), colors.white),&#10;        ('BOTTOMPADDING', (0, 0), (-1, -1), 8),&#10;        ('GRID', (0, 0), (-1, -1), 1, colors.lightgrey)&#10;    ]))&#10;    elements.append(summary_table)&#10;    elements.append(Spacer(1, 0.3*inch))&#10;&#10;    # Footer&#10;    footer_style = ParagraphStyle(&#10;        'Footer',&#10;        parent=styles['Normal'],&#10;        fontSize=9,&#10;        textColor=colors.grey,&#10;        alignment=1&#10;    )&#10;    elements.append(Paragraph(&quot;Thank you for your purchase!&quot;, footer_style))&#10;    elements.append(Paragraph(&quot;For any queries, contact: support@order2wear.com&quot;, footer_style))&#10;    elements.append(Paragraph(&quot;Visit us: www.order2wear.com&quot;, footer_style))&#10;&#10;    # Build PDF&#10;    doc.build(elements)&#10;&#10;    # Return PDF&#10;    buffer.seek(0)&#10;    response = HttpResponse(buffer.getvalue(), content_type='application/pdf')&#10;    response['Content-Disposition'] = f'attachment; filename=&quot;invoice-{order.id}.pdf&quot;'&#10;    return response&#10;" />
              <option name="updatedContent" value="from django.shortcuts import render, redirect, get_object_or_404&#10;from django.contrib.auth import authenticate, login, logout&#10;from django.contrib.auth.decorators import login_required&#10;from django.contrib import messages&#10;from django.db.models import Q&#10;from .models import Product, Category, Cart, CartItem, UserProfile, Order, ShippingMethod, TaxRate&#10;from .forms import CustomUserCreationForm, CustomAuthenticationForm, UserProfileForm&#10;import json&#10;from django.http import JsonResponse&#10;&#10;&#10;def home(request):&#10;    &quot;&quot;&quot;Homepage with featured products&quot;&quot;&quot;&#10;    from .models import TrendingImage, Coupon&#10;    from django.utils import timezone&#10;&#10;    featured_products = Product.objects.filter(is_active=True)[:8]&#10;    categories = Category.objects.all()&#10;    trending_images = TrendingImage.objects.filter(is_active=True)&#10;&#10;    # Get featured coupon if available and valid&#10;    now = timezone.now()&#10;    featured_coupon = Coupon.objects.filter(&#10;        is_featured=True,&#10;        is_active=True,&#10;        valid_from__lte=now,&#10;        valid_until__gte=now&#10;    ).first()&#10;&#10;    context = {&#10;        'featured_products': featured_products,&#10;        'categories': categories,&#10;        'trending_images': trending_images,&#10;        'featured_coupon': featured_coupon,&#10;        'page_title': 'Home'&#10;    }&#10;    return render(request, 'ecommerce/home.html', context)&#10;&#10;&#10;def product_list(request):&#10;    &quot;&quot;&quot;Display all products with filtering&quot;&quot;&quot;&#10;    products = Product.objects.filter(is_active=True)&#10;    categories = Category.objects.all()&#10;&#10;    # Filter by category&#10;    category_id = request.GET.get('category')&#10;    if category_id:&#10;        products = products.filter(category_id=category_id)&#10;&#10;    # Search&#10;    search_query = request.GET.get('q')&#10;    if search_query:&#10;        products = products.filter(&#10;            Q(name__icontains=search_query) |&#10;            Q(description__icontains=search_query)&#10;        )&#10;&#10;    # Sorting&#10;    sort = request.GET.get('sort', '-created_at')&#10;    products = products.order_by(sort)&#10;&#10;    context = {&#10;        'products': products,&#10;        'categories': categories,&#10;        'search_query': search_query,&#10;        'selected_category': category_id,&#10;        'page_title': 'Products'&#10;    }&#10;    return render(request, 'ecommerce/product_list.html', context)&#10;&#10;&#10;def product_detail(request, slug):&#10;    &quot;&quot;&quot;Display product details&quot;&quot;&quot;&#10;    product = get_object_or_404(Product, slug=slug, is_active=True)&#10;    related_products = Product.objects.filter(&#10;        category=product.category,&#10;        is_active=True&#10;    ).exclude(id=product.id)[:4]&#10;&#10;    context = {&#10;        'product': product,&#10;        'related_products': related_products,&#10;        'page_title': product.name&#10;    }&#10;    return render(request, 'ecommerce/product_detail.html', context)&#10;&#10;&#10;def signup(request):&#10;    &quot;&quot;&quot;User registration&quot;&quot;&quot;&#10;    if request.user.is_authenticated:&#10;        return redirect('ecommerce:home')&#10;&#10;    if request.method == 'POST':&#10;        form = CustomUserCreationForm(request.POST)&#10;        if form.is_valid():&#10;            user = form.save()&#10;            # Create cart for new user (signal should handle this)&#10;            Cart.objects.get_or_create(user=user)&#10;            messages.success(request, 'Account created successfully! Please log in.')&#10;            return redirect('ecommerce:login')&#10;        else:&#10;            for field, errors in form.errors.items():&#10;                for error in errors:&#10;                    messages.error(request, f&quot;{field}: {error}&quot;)&#10;    else:&#10;        form = CustomUserCreationForm()&#10;&#10;    context = {&#10;        'form': form,&#10;        'page_title': 'Sign Up'&#10;    }&#10;    return render(request, 'ecommerce/signup.html', context)&#10;&#10;&#10;def login_view(request):&#10;    &quot;&quot;&quot;User login&quot;&quot;&quot;&#10;    if request.user.is_authenticated:&#10;        return redirect('ecommerce:home')&#10;&#10;    if request.method == 'POST':&#10;        form = CustomAuthenticationForm(request, data=request.POST)&#10;        if form.is_valid():&#10;            username = form.cleaned_data.get('username')&#10;            password = form.cleaned_data.get('password')&#10;            user = authenticate(username=username, password=password)&#10;            if user is not None:&#10;                login(request, user)&#10;                messages.success(request, f'Welcome back, {user.username}!')&#10;                return redirect('ecommerce:home')&#10;    else:&#10;        form = CustomAuthenticationForm()&#10;&#10;    context = {&#10;        'form': form,&#10;        'page_title': 'Login'&#10;    }&#10;    return render(request, 'ecommerce/login.html', context)&#10;&#10;&#10;def logout_view(request):&#10;    &quot;&quot;&quot;User logout&quot;&quot;&quot;&#10;    logout(request)&#10;    messages.success(request, 'You have been logged out successfully.')&#10;    return redirect('ecommerce:home')&#10;&#10;&#10;@login_required(login_url='ecommerce:login')&#10;def profile(request):&#10;    &quot;&quot;&quot;User profile&quot;&quot;&quot;&#10;    from .models import Order, Wishlist&#10;&#10;    user_profile = get_object_or_404(UserProfile, user=request.user)&#10;&#10;    if request.method == 'POST':&#10;        form = UserProfileForm(request.POST, request.FILES, instance=user_profile)&#10;        if form.is_valid():&#10;            form.save()&#10;            messages.success(request, 'Profile updated successfully!')&#10;            return redirect('ecommerce:profile')&#10;    else:&#10;        form = UserProfileForm(instance=user_profile)&#10;&#10;    # Calculate statistics&#10;    total_orders = Order.objects.filter(user=request.user).count()&#10;    completed_orders = Order.objects.filter(user=request.user, status='completed').count()&#10;    pending_orders = Order.objects.filter(user=request.user, status='pending').count()&#10;&#10;    # Get wishlist count&#10;    wishlist_count = 0&#10;    try:&#10;        wishlist = Wishlist.objects.get(user=request.user)&#10;        wishlist_count = wishlist.products.count()&#10;    except Wishlist.DoesNotExist:&#10;        wishlist_count = 0&#10;&#10;    context = {&#10;        'form': form,&#10;        'user_profile': user_profile,&#10;        'page_title': 'My Profile',&#10;        'total_orders': total_orders,&#10;        'completed_orders': completed_orders,&#10;        'pending_orders': pending_orders,&#10;        'wishlist_count': wishlist_count,&#10;    }&#10;    return render(request, 'ecommerce/profile.html', context)&#10;&#10;&#10;@login_required(login_url='ecommerce:login')&#10;def add_to_cart(request, product_id):&#10;    &quot;&quot;&quot;Add product to cart&quot;&quot;&quot;&#10;    product = get_object_or_404(Product, id=product_id)&#10;    cart, created = Cart.objects.get_or_create(user=request.user)&#10;&#10;    quantity = int(request.POST.get('quantity', 1))&#10;&#10;    # Validate stock&#10;    if quantity &gt; product.stock:&#10;        messages.error(request, f'Only {product.stock} items available in stock!')&#10;        return redirect(request.META.get('HTTP_REFERER', 'ecommerce:home'))&#10;&#10;    if quantity &lt;= 0:&#10;        messages.error(request, 'Quantity must be greater than 0!')&#10;        return redirect(request.META.get('HTTP_REFERER', 'ecommerce:home'))&#10;&#10;    cart_item, created = CartItem.objects.get_or_create(&#10;        cart=cart,&#10;        product=product,&#10;        defaults={'quantity': quantity}&#10;    )&#10;&#10;    if not created:&#10;        # Check if total quantity exceeds stock&#10;        new_quantity = cart_item.quantity + quantity&#10;        if new_quantity &gt; product.stock:&#10;            messages.error(request, f'Only {product.stock - cart_item.quantity} more items can be added!')&#10;            return redirect('ecommerce:cart')&#10;        cart_item.quantity = new_quantity&#10;        cart_item.save()&#10;&#10;    messages.success(request, f'{product.name} added to cart!')&#10;    return redirect('ecommerce:cart')&#10;&#10;&#10;@login_required(login_url='ecommerce:login')&#10;def cart_view(request):&#10;    &quot;&quot;&quot;View shopping cart&quot;&quot;&quot;&#10;    from decimal import Decimal&#10;    from .models import ShippingMethod, TaxRate&#10;&#10;    try:&#10;        cart = Cart.objects.get(user=request.user)&#10;    except Cart.DoesNotExist:&#10;        cart = Cart.objects.create(user=request.user)&#10;&#10;    # Get admin-configured shipping and tax&#10;    # First try to get default tax rate, if not available get any active tax rate&#10;    tax_rate = TaxRate.objects.filter(is_active=True, is_default=True).first()&#10;    if not tax_rate:&#10;        tax_rate = TaxRate.objects.filter(is_active=True).first()&#10;&#10;    shipping_method = ShippingMethod.objects.filter(is_active=True).first()&#10;&#10;    subtotal = Decimal(str(cart.get_total()))&#10;    shipping = Decimal(str(shipping_method.price)) if shipping_method else Decimal('0.00')&#10;&#10;    if tax_rate:&#10;        tax_amount = Decimal(str(tax_rate.calculate_tax(subtotal + shipping)))&#10;    else:&#10;        tax_amount = Decimal('0.00')&#10;&#10;    total_amount = subtotal + shipping + tax_amount&#10;&#10;    context = {&#10;        'cart': cart,&#10;        'subtotal': subtotal,&#10;        'shipping': shipping,&#10;        'shipping_method': shipping_method,&#10;        'tax_amount': tax_amount,&#10;        'tax_rate': tax_rate,&#10;        'total_amount': total_amount,&#10;        'page_title': 'Shopping Cart'&#10;    }&#10;    return render(request, 'ecommerce/cart.html', context)&#10;&#10;&#10;@login_required(login_url='ecommerce:login')&#10;def remove_from_cart(request, cart_item_id):&#10;    &quot;&quot;&quot;Remove item from cart&quot;&quot;&quot;&#10;    cart_item = get_object_or_404(CartItem, id=cart_item_id, cart__user=request.user)&#10;    product_name = cart_item.product.name&#10;    cart_item.delete()&#10;    messages.success(request, f'{product_name} removed from cart!')&#10;    return redirect('ecommerce:cart')&#10;&#10;&#10;@login_required(login_url='ecommerce:login')&#10;def update_cart_item(request, cart_item_id):&#10;    &quot;&quot;&quot;Update cart item quantity&quot;&quot;&quot;&#10;    cart_item = get_object_or_404(CartItem, id=cart_item_id, cart__user=request.user)&#10;    quantity = int(request.POST.get('quantity', 1))&#10;&#10;    # Validate stock&#10;    if quantity &gt; cart_item.product.stock:&#10;        messages.error(request, f'Only {cart_item.product.stock} items available in stock!')&#10;        return redirect('ecommerce:cart')&#10;&#10;    if quantity &lt;= 0:&#10;        messages.error(request, 'Quantity must be greater than 0!')&#10;        return redirect('ecommerce:cart')&#10;&#10;    cart_item.quantity = quantity&#10;    cart_item.save()&#10;    messages.success(request, 'Cart updated!')&#10;&#10;    return redirect('ecommerce:cart')&#10;&#10;&#10;@login_required(login_url='ecommerce:login')&#10;def add_to_wishlist(request, product_id):&#10;    &quot;&quot;&quot;Add product to wishlist&quot;&quot;&quot;&#10;    from .models import Wishlist&#10;&#10;    product = get_object_or_404(Product, id=product_id)&#10;&#10;    # Get or create wishlist for user&#10;    wishlist, created = Wishlist.objects.get_or_create(user=request.user)&#10;&#10;    if product in wishlist.products.all():&#10;        wishlist.products.remove(product)&#10;        messages.info(request, f'{product.name} removed from wishlist!')&#10;    else:&#10;        wishlist.products.add(product)&#10;        messages.success(request, f'{product.name} added to wishlist!')&#10;&#10;    return redirect(request.META.get('HTTP_REFERER', 'ecommerce:home'))&#10;&#10;&#10;@login_required(login_url='ecommerce:login')&#10;def remove_from_wishlist(request, product_id):&#10;    &quot;&quot;&quot;Remove product from wishlist&quot;&quot;&quot;&#10;    from .models import Wishlist&#10;&#10;    product = get_object_or_404(Product, id=product_id)&#10;&#10;    try:&#10;        wishlist = Wishlist.objects.get(user=request.user)&#10;        wishlist.products.remove(product)&#10;        messages.success(request, f'{product.name} removed from wishlist!')&#10;    except Wishlist.DoesNotExist:&#10;        messages.error(request, 'Wishlist not found!')&#10;&#10;    return redirect(request.META.get('HTTP_REFERER', 'ecommerce:home'))&#10;&#10;&#10;@login_required(login_url='ecommerce:login')&#10;def share_product(request, product_id):&#10;    &quot;&quot;&quot;Generate shareable link for product&quot;&quot;&quot;&#10;    product = get_object_or_404(Product, id=product_id)&#10;    from django.urls import reverse&#10;    product_url = request.build_absolute_uri(reverse('ecommerce:product_detail', kwargs={'slug': product.slug}))&#10;&#10;    context = {&#10;        'product': product,&#10;        'share_url': product_url,&#10;        'share_text': f'Check out {product.name} on Order2Wear!',&#10;    }&#10;    return render(request, 'ecommerce/share_product.html', context)&#10;&#10;&#10;@login_required(login_url='ecommerce:login')&#10;def update_cart_item_ajax(request, cart_item_id):&#10;    &quot;&quot;&quot;Update cart item quantity via AJAX and return updated totals&quot;&quot;&quot;&#10;    if request.method == 'POST' and request.headers.get('X-Requested-With') == 'XMLHttpRequest':&#10;        from decimal import Decimal&#10;&#10;        cart_item = get_object_or_404(CartItem, id=cart_item_id, cart__user=request.user)&#10;        quantity = int(request.POST.get('quantity', 1))&#10;&#10;        # Validate quantity against stock&#10;        if quantity &gt; cart_item.product.stock:&#10;            return JsonResponse({&#10;                'success': False,&#10;                'message': f'Only {cart_item.product.stock} items available in stock!'&#10;            })&#10;&#10;        if quantity &gt; 0:&#10;            cart_item.quantity = quantity&#10;            cart_item.save()&#10;        else:&#10;            return JsonResponse({'success': False, 'message': 'Quantity must be at least 1'})&#10;&#10;        # Calculate new totals&#10;        from .models import ShippingMethod, TaxRate&#10;&#10;        cart = cart_item.cart&#10;        shipping_method = ShippingMethod.objects.filter(is_active=True).first()&#10;        # First try to get default tax rate, if not available get any active tax rate&#10;        tax_rate = TaxRate.objects.filter(is_active=True, is_default=True).first()&#10;        if not tax_rate:&#10;            tax_rate = TaxRate.objects.filter(is_active=True).first()&#10;&#10;        subtotal = Decimal(str(cart.get_total()))&#10;        shipping = Decimal(str(shipping_method.price)) if shipping_method else Decimal('0.00')&#10;&#10;        if tax_rate:&#10;            tax_amount = Decimal(str(tax_rate.calculate_tax(subtotal + shipping)))&#10;        else:&#10;            tax_amount = Decimal('0.00')&#10;&#10;        total_amount = subtotal + shipping + tax_amount&#10;&#10;        return JsonResponse({&#10;            'success': True,&#10;            'item_total': float(cart_item.get_total()),&#10;            'subtotal': float(subtotal),&#10;            'tax': float(tax_amount),&#10;            'total': float(total_amount),&#10;            'message': 'Cart updated successfully!'&#10;        })&#10;&#10;    return JsonResponse({'success': False, 'message': 'Invalid request'})&#10;&#10;&#10;@login_required(login_url='ecommerce:login')&#10;def wishlist_view(request):&#10;    &quot;&quot;&quot;Display user's wishlist&quot;&quot;&quot;&#10;    from .models import Wishlist&#10;&#10;    try:&#10;        wishlist = Wishlist.objects.get(user=request.user)&#10;        wishlisted_products = wishlist.products.all()&#10;    except Wishlist.DoesNotExist:&#10;        wishlist = Wishlist.objects.create(user=request.user)&#10;        wishlisted_products = wishlist.products.all()&#10;&#10;    context = {&#10;        'wishlisted_products': wishlisted_products,&#10;        'page_title': 'My Wishlist'&#10;    }&#10;    return render(request, 'ecommerce/wishlist.html', context)&#10;&#10;&#10;def about_view(request):&#10;    &quot;&quot;&quot;About page view&quot;&quot;&quot;&#10;    context = {&#10;        'page_title': 'About Us'&#10;    }&#10;    return render(request, 'ecommerce/about.html', context)&#10;&#10;&#10;def blog_view(request):&#10;    &quot;&quot;&quot;Blog page view with published posts&quot;&quot;&quot;&#10;    from .models import BlogPost, BlogCategory&#10;&#10;    posts = BlogPost.objects.filter(is_published=True).order_by('-created_at')&#10;    featured_post = BlogPost.objects.filter(is_published=True, is_featured=True).first()&#10;    categories = BlogCategory.objects.all()&#10;&#10;    # Filter by category&#10;    category_id = request.GET.get('category')&#10;    if category_id:&#10;        posts = posts.filter(category_id=category_id)&#10;&#10;    # Search&#10;    search_query = request.GET.get('q')&#10;    if search_query:&#10;        from django.db.models import Q&#10;        posts = posts.filter(&#10;            Q(title__icontains=search_query) |&#10;            Q(content__icontains=search_query)&#10;        )&#10;&#10;    context = {&#10;        'posts': posts,&#10;        'featured_post': featured_post,&#10;        'categories': categories,&#10;        'search_query': search_query,&#10;        'selected_category': category_id,&#10;        'page_title': 'Blog'&#10;    }&#10;    return render(request, 'ecommerce/blog.html', context)&#10;&#10;&#10;def blog_detail(request, slug):&#10;    &quot;&quot;&quot;Blog post detail view&quot;&quot;&quot;&#10;    from .models import BlogPost&#10;&#10;    post = get_object_or_404(BlogPost, slug=slug, is_published=True)&#10;&#10;    # Increment views&#10;    post.views += 1&#10;    post.save(update_fields=['views'])&#10;&#10;    # Get related posts&#10;    related_posts = BlogPost.objects.filter(&#10;        is_published=True,&#10;        category=post.category&#10;    ).exclude(id=post.id)[:3]&#10;&#10;    context = {&#10;        'post': post,&#10;        'related_posts': related_posts,&#10;        'page_title': post.title&#10;    }&#10;    return render(request, 'ecommerce/blog_detail.html', context)&#10;&#10;&#10;@login_required(login_url='ecommerce:login')&#10;def my_orders(request):&#10;    &quot;&quot;&quot;Display user's orders&quot;&quot;&quot;&#10;    from .models import Order&#10;&#10;    orders = Order.objects.filter(user=request.user).order_by('-created_at')&#10;&#10;    context = {&#10;        'orders': orders,&#10;        'page_title': 'My Orders'&#10;    }&#10;    return render(request, 'ecommerce/my_orders.html', context)&#10;&#10;&#10;@login_required(login_url='ecommerce:login')&#10;def order_detail(request, order_id):&#10;    &quot;&quot;&quot;Display order details&quot;&quot;&quot;&#10;    from .models import Order&#10;&#10;    order = get_object_or_404(Order, id=order_id, user=request.user)&#10;&#10;    context = {&#10;        'order': order,&#10;        'page_title': f'Order #{order.id}'&#10;    }&#10;    return render(request, 'ecommerce/order_detail.html', context)&#10;&#10;&#10;@login_required(login_url='ecommerce:login')&#10;def settings_view(request):&#10;    &quot;&quot;&quot;User settings page&quot;&quot;&quot;&#10;    user_profile = get_object_or_404(UserProfile, user=request.user)&#10;&#10;    if request.method == 'POST':&#10;        form = UserProfileForm(request.POST, request.FILES, instance=user_profile)&#10;        if form.is_valid():&#10;            form.save()&#10;            messages.success(request, 'Settings updated successfully!')&#10;            return redirect('ecommerce:settings')&#10;    else:&#10;        form = UserProfileForm(instance=user_profile)&#10;&#10;    context = {&#10;        'form': form,&#10;        'user_profile': user_profile,&#10;        'page_title': 'Settings'&#10;    }&#10;    return render(request, 'ecommerce/settings.html', context)&#10;&#10;&#10;@login_required(login_url='ecommerce:login')&#10;def checkout(request):&#10;    &quot;&quot;&quot;Checkout page with payment processing&quot;&quot;&quot;&#10;    from decimal import Decimal&#10;    from .models import Order, OrderItem, Cart, Coupon&#10;&#10;    try:&#10;        cart = Cart.objects.get(user=request.user)&#10;    except Cart.DoesNotExist:&#10;        messages.error(request, 'Your cart is empty!')&#10;        return redirect('ecommerce:cart')&#10;&#10;    if not cart.items.exists():&#10;        messages.error(request, 'Your cart is empty!')&#10;        return redirect('ecommerce:cart')&#10;&#10;    user_profile = get_object_or_404(UserProfile, user=request.user)&#10;&#10;    # Get applied coupon from session&#10;    applied_coupon = None&#10;    coupon_discount = Decimal('0.00')&#10;&#10;    if 'applied_coupon' in request.session:&#10;        try:&#10;            applied_coupon = Coupon.objects.get(code__iexact=request.session['applied_coupon'])&#10;            if applied_coupon.is_valid():&#10;                subtotal = Decimal(str(cart.get_total()))&#10;                coupon_discount = Decimal(str(applied_coupon.get_discount_amount(subtotal)))&#10;        except Coupon.DoesNotExist:&#10;            del request.session['applied_coupon']&#10;&#10;    if request.method == 'POST':&#10;        # Get form data for shipping information&#10;        first_name = request.POST.get('first_name', '').strip()&#10;        last_name = request.POST.get('last_name', '').strip()&#10;        email = request.POST.get('email', '').strip()&#10;        phone = request.POST.get('phone', '').strip()&#10;        shipping_address = request.POST.get('shipping_address', '').strip()&#10;        city = request.POST.get('city', '').strip()&#10;        state = request.POST.get('state', '').strip()&#10;        postal_code = request.POST.get('postal_code', '').strip()&#10;        country = request.POST.get('country', '').strip()&#10;        payment_method = request.POST.get('payment_method', 'cod')&#10;&#10;        # Validate required fields&#10;        if not all([first_name, last_name, email, phone, shipping_address, city, state, postal_code, country]):&#10;            messages.error(request, 'Please fill in all required shipping information fields.')&#10;            return redirect('ecommerce:checkout')&#10;&#10;        # Get admin-configured shipping and tax&#10;        from .models import ShippingMethod, TaxRate&#10;        shipping_method = ShippingMethod.objects.filter(is_active=True).first()&#10;        # First try to get default tax rate, if not available get any active tax rate&#10;        tax_rate = TaxRate.objects.filter(is_active=True, is_default=True).first()&#10;        if not tax_rate:&#10;            tax_rate = TaxRate.objects.filter(is_active=True).first()&#10;&#10;        # Calculate totals&#10;        subtotal = Decimal(str(cart.get_total()))&#10;        shipping = Decimal(str(shipping_method.price)) if shipping_method else Decimal('0.00')&#10;        subtotal_with_coupon = subtotal - coupon_discount&#10;&#10;        if tax_rate:&#10;            tax_amount = Decimal(str(tax_rate.calculate_tax(subtotal_with_coupon + shipping)))&#10;        else:&#10;            tax_amount = Decimal('0.00')&#10;&#10;        total_amount = subtotal_with_coupon + shipping + tax_amount&#10;&#10;        # Create order with shipping information and references to shipping and tax&#10;        order = Order.objects.create(&#10;            user=request.user,&#10;            shipping_method=shipping_method,&#10;            tax_rate=tax_rate,&#10;            subtotal=subtotal,&#10;            shipping_cost=shipping,&#10;            tax_amount=tax_amount,&#10;            total_amount=total_amount,&#10;            status='pending'&#10;        )&#10;&#10;        # Create order items&#10;        for cart_item in cart.items.all():&#10;            OrderItem.objects.create(&#10;                order=order,&#10;                product=cart_item.product,&#10;                quantity=cart_item.quantity,&#10;                price=cart_item.product.price&#10;            )&#10;            # Update product sold count&#10;            cart_item.product.total_sold += cart_item.quantity&#10;            cart_item.product.save(update_fields=['total_sold'])&#10;&#10;        # Apply coupon if exists&#10;        if applied_coupon:&#10;            applied_coupon.apply()&#10;            del request.session['applied_coupon']&#10;&#10;        # Process payment&#10;        if payment_method == 'card':&#10;            # Credit card (currently disabled in frontend)&#10;            order.status = 'completed'&#10;            order.save(update_fields=['status'])&#10;            cart.items.all().delete()&#10;            messages.success(request, f'Order #{order.id} placed successfully! Payment processed.')&#10;            return redirect('ecommerce:order_detail', order_id=order.id)&#10;        elif payment_method == 'cod':&#10;            # Cash on Delivery (Only enabled payment method)&#10;            order.status = 'pending'&#10;            order.save(update_fields=['status'])&#10;            cart.items.all().delete()&#10;            messages.success(request, f'Order #{order.id} placed! We will contact you for payment confirmation.')&#10;            return redirect('ecommerce:order_detail', order_id=order.id)&#10;        else:&#10;            # Any other payment method (currently disabled)&#10;            order.status = 'pending'&#10;            order.save(update_fields=['status'])&#10;            cart.items.all().delete()&#10;            messages.success(request, f'Order #{order.id} placed! Awaiting payment verification.')&#10;            return redirect('ecommerce:order_detail', order_id=order.id)&#10;&#10;    # Get admin-configured shipping and tax&#10;    from .models import ShippingMethod, TaxRate&#10;    shipping_method = ShippingMethod.objects.filter(is_active=True).first()&#10;    # First try to get default tax rate, if not available get any active tax rate&#10;    tax_rate = TaxRate.objects.filter(is_active=True, is_default=True).first()&#10;    if not tax_rate:&#10;        tax_rate = TaxRate.objects.filter(is_active=True).first()&#10;&#10;    # Calculate totals&#10;    subtotal = Decimal(str(cart.get_total()))&#10;    shipping = Decimal(str(shipping_method.price)) if shipping_method else Decimal('0.00')&#10;    subtotal_with_coupon = subtotal - coupon_discount&#10;&#10;    if tax_rate:&#10;        tax_amount = Decimal(str(tax_rate.calculate_tax(subtotal_with_coupon + shipping)))&#10;    else:&#10;        tax_amount = Decimal('0.00')&#10;&#10;    total_amount = subtotal_with_coupon + shipping + tax_amount&#10;&#10;    context = {&#10;        'cart': cart,&#10;        'user_profile': user_profile,&#10;        'subtotal': subtotal,&#10;        'coupon_discount': coupon_discount,&#10;        'shipping': shipping,&#10;        'shipping_method': shipping_method,&#10;        'tax_amount': tax_amount,&#10;        'tax_rate': tax_rate,&#10;        'total_amount': total_amount,&#10;        'applied_coupon': applied_coupon,&#10;        'page_title': 'Checkout'&#10;    }&#10;    return render(request, 'ecommerce/checkout.html', context)&#10;&#10;&#10;@login_required(login_url='ecommerce:login')&#10;def apply_coupon(request):&#10;    &quot;&quot;&quot;Apply coupon code to cart via AJAX&quot;&quot;&quot;&#10;    from decimal import Decimal&#10;    from .models import Cart, Coupon&#10;&#10;    if request.method == 'POST' and request.headers.get('X-Requested-With') == 'XMLHttpRequest':&#10;        coupon_code = request.POST.get('coupon_code', '').strip().upper()&#10;&#10;        try:&#10;            cart = Cart.objects.get(user=request.user)&#10;        except Cart.DoesNotExist:&#10;            return JsonResponse({&#10;                'success': False,&#10;                'message': 'Cart is empty!'&#10;            })&#10;&#10;        try:&#10;            # Use case-insensitive lookup&#10;            coupon = Coupon.objects.get(code__iexact=coupon_code)&#10;        except Coupon.DoesNotExist:&#10;            return JsonResponse({&#10;                'success': False,&#10;                'message': f'Coupon code &quot;{coupon_code}&quot; not found!'&#10;            })&#10;&#10;        # Check if coupon is valid&#10;        if not coupon.is_valid():&#10;            if coupon.current_uses &gt;= coupon.max_uses:&#10;                return JsonResponse({&#10;                    'success': False,&#10;                    'message': 'This coupon has reached its usage limit!'&#10;                })&#10;            else:&#10;                return JsonResponse({&#10;                    'success': False,&#10;                    'message': 'This coupon is no longer valid!'&#10;                })&#10;&#10;        # Check minimum order amount&#10;        subtotal = Decimal(str(cart.get_total()))&#10;        if subtotal &lt; coupon.min_order_amount:&#10;            return JsonResponse({&#10;                'success': False,&#10;                'message': f'Minimum order amount ${coupon.min_order_amount} required for this coupon!'&#10;            })&#10;&#10;        # Apply coupon - store the actual code from database&#10;        request.session['applied_coupon'] = coupon.code&#10;        coupon_discount = Decimal(str(coupon.get_discount_amount(subtotal)))&#10;&#10;        # Get admin-configured shipping and tax&#10;        from .models import ShippingMethod, TaxRate&#10;        shipping_method = ShippingMethod.objects.filter(is_active=True).first()&#10;        # First try to get default tax rate, if not available get any active tax rate&#10;        tax_rate = TaxRate.objects.filter(is_active=True, is_default=True).first()&#10;        if not tax_rate:&#10;            tax_rate = TaxRate.objects.filter(is_active=True).first()&#10;&#10;        # Recalculate totals&#10;        subtotal_with_coupon = subtotal - coupon_discount&#10;        shipping = Decimal(str(shipping_method.price)) if shipping_method else Decimal('0.00')&#10;&#10;        if tax_rate:&#10;            tax_amount = Decimal(str(tax_rate.calculate_tax(subtotal_with_coupon + shipping)))&#10;        else:&#10;            tax_amount = Decimal('0.00')&#10;&#10;        total_amount = subtotal_with_coupon + shipping + tax_amount&#10;&#10;        return JsonResponse({&#10;            'success': True,&#10;            'message': f'Coupon &quot;{coupon_code}&quot; applied successfully!',&#10;            'coupon_code': coupon_code,&#10;            'coupon_discount': float(coupon_discount),&#10;            'subtotal': float(subtotal),&#10;            'subtotal_with_coupon': float(subtotal_with_coupon),&#10;            'tax': float(tax_amount),&#10;            'total': float(total_amount)&#10;        })&#10;&#10;    return JsonResponse({'success': False, 'message': 'Invalid request'})&#10;&#10;&#10;@login_required(login_url='ecommerce:login')&#10;def remove_coupon(request):&#10;    &quot;&quot;&quot;Remove applied coupon code&quot;&quot;&quot;&#10;    if request.method == 'POST' and request.headers.get('X-Requested-With') == 'XMLHttpRequest':&#10;        from decimal import Decimal&#10;        from .models import Cart&#10;&#10;        try:&#10;            cart = Cart.objects.get(user=request.user)&#10;        except Cart.DoesNotExist:&#10;            return JsonResponse({&#10;                'success': False,&#10;                'message': 'Cart is empty!'&#10;            })&#10;&#10;        if 'applied_coupon' in request.session:&#10;            del request.session['applied_coupon']&#10;&#10;        # Get admin-configured shipping and tax&#10;        from .models import ShippingMethod, TaxRate&#10;        shipping_method = ShippingMethod.objects.filter(is_active=True).first()&#10;        # First try to get default tax rate, if not available get any active tax rate&#10;        tax_rate = TaxRate.objects.filter(is_active=True, is_default=True).first()&#10;        if not tax_rate:&#10;            tax_rate = TaxRate.objects.filter(is_active=True).first()&#10;&#10;        # Recalculate totals without coupon using admin config&#10;        subtotal = Decimal(str(cart.get_total()))&#10;        shipping = Decimal(str(shipping_method.price)) if shipping_method else Decimal('0.00')&#10;&#10;        if tax_rate:&#10;            tax_amount = Decimal(str(tax_rate.calculate_tax(subtotal + shipping)))&#10;        else:&#10;            tax_amount = Decimal('0.00')&#10;&#10;        total_amount = subtotal + shipping + tax_amount&#10;&#10;        return JsonResponse({&#10;            'success': True,&#10;            'message': 'Coupon removed successfully!',&#10;            'subtotal': float(subtotal),&#10;            'tax': float(tax_amount),&#10;            'total': float(total_amount),&#10;            'coupon_discount': 0.0&#10;        })&#10;&#10;    return JsonResponse({'success': False, 'message': 'Invalid request'})&#10;&#10;&#10;@login_required(login_url='ecommerce:login')&#10;def download_invoice(request, order_id):&#10;    &quot;&quot;&quot;Download order invoice as PDF with professional formatting&quot;&quot;&quot;&#10;    from django.http import HttpResponse&#10;    from reportlab.lib.pagesizes import letter&#10;    from reportlab.platypus import SimpleDocTemplate, Table, TableStyle, Paragraph, Spacer&#10;    from reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle&#10;    from reportlab.lib.units import inch&#10;    from reportlab.lib import colors&#10;    from io import BytesIO&#10;&#10;    order = get_object_or_404(Order, id=order_id, user=request.user)&#10;&#10;    # Create PDF in memory&#10;    buffer = BytesIO()&#10;    doc = SimpleDocTemplate(buffer, pagesize=letter, rightMargin=0.5*inch, leftMargin=0.5*inch,&#10;                          topMargin=0.5*inch, bottomMargin=0.5*inch)&#10;&#10;    elements = []&#10;    styles = getSampleStyleSheet()&#10;&#10;    # Custom styles&#10;    title_style = ParagraphStyle(&#10;        'CustomTitle',&#10;        parent=styles['Heading1'],&#10;        fontSize=24,&#10;        textColor=colors.HexColor('#667eea'),&#10;        spaceAfter=6,&#10;        alignment=1&#10;    )&#10;&#10;    heading_style = ParagraphStyle(&#10;        'CustomHeading',&#10;        parent=styles['Heading2'],&#10;        fontSize=14,&#10;        textColor=colors.HexColor('#667eea'),&#10;        spaceAfter=12,&#10;        spaceBefore=12&#10;    )&#10;&#10;    # Title&#10;    elements.append(Paragraph(&quot;️ Order2Wear Invoice&quot;, title_style))&#10;    elements.append(Spacer(1, 0.2*inch))&#10;&#10;    # Invoice header info&#10;    header_data = [&#10;        ['Invoice #', f'{order.id}', 'Date', order.created_at.strftime('%B %d, %Y')],&#10;        ['Status', order.get_status_display(), 'Order Time', order.created_at.strftime('%I:%M %p')],&#10;    ]&#10;&#10;    header_table = Table(header_data, colWidths=[1.5*inch, 1.5*inch, 1.5*inch, 1.5*inch])&#10;    header_table.setStyle(TableStyle([&#10;        ('BACKGROUND', (0, 0), (-1, -1), colors.HexColor('#f0f0f0')),&#10;        ('TEXTCOLOR', (0, 0), (-1, -1), colors.black),&#10;        ('ALIGN', (0, 0), (-1, -1), 'LEFT'),&#10;        ('FONTNAME', (0, 0), (-1, -1), 'Helvetica-Bold'),&#10;        ('FONTSIZE', (0, 0), (-1, -1), 10),&#10;        ('BOTTOMPADDING', (0, 0), (-1, -1), 8),&#10;        ('GRID', (0, 0), (-1, -1), 1, colors.black)&#10;    ]))&#10;    elements.append(header_table)&#10;    elements.append(Spacer(1, 0.2*inch))&#10;&#10;    # Customer info&#10;    elements.append(Paragraph(&quot;Customer Information&quot;, heading_style))&#10;    customer_data = [&#10;        ['Name', order.user.get_full_name() or order.user.username],&#10;        ['Email', order.user.email],&#10;    ]&#10;&#10;    customer_table = Table(customer_data, colWidths=[1.5*inch, 5*inch])&#10;    customer_table.setStyle(TableStyle([&#10;        ('BACKGROUND', (0, 0), (0, -1), colors.HexColor('#667eea')),&#10;        ('TEXTCOLOR', (0, 0), (0, -1), colors.white),&#10;        ('ALIGN', (0, 0), (-1, -1), 'LEFT'),&#10;        ('FONTNAME', (0, 0), (0, -1), 'Helvetica-Bold'),&#10;        ('FONTSIZE', (0, 0), (-1, -1), 10),&#10;        ('BOTTOMPADDING', (0, 0), (-1, -1), 8),&#10;        ('GRID', (0, 0), (-1, -1), 1, colors.black)&#10;    ]))&#10;    elements.append(customer_table)&#10;    elements.append(Spacer(1, 0.2*inch))&#10;&#10;    # Order items&#10;    elements.append(Paragraph(&quot;Order Items&quot;, heading_style))&#10;&#10;    items_data = [['Product', 'Quantity', 'Unit Price', 'Total']]&#10;&#10;    for item in order.items.all():&#10;        items_data.append([&#10;            item.product.name[:40],&#10;            str(item.quantity),&#10;            f'₨{item.price:.2f}',&#10;            f'₨{item.price * item.quantity:.2f}'&#10;        ])&#10;&#10;    items_table = Table(items_data, colWidths=[2.5*inch, 1*inch, 1.5*inch, 1.5*inch])&#10;    items_table.setStyle(TableStyle([&#10;        ('BACKGROUND', (0, 0), (-1, 0), colors.HexColor('#667eea')),&#10;        ('TEXTCOLOR', (0, 0), (-1, 0), colors.white),&#10;        ('ALIGN', (0, 0), (-1, -1), 'CENTER'),&#10;        ('ALIGN', (0, 0), (0, -1), 'LEFT'),&#10;        ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),&#10;        ('FONTSIZE', (0, 0), (-1, -1), 9),&#10;        ('BOTTOMPADDING', (0, 0), (-1, 0), 10),&#10;        ('GRID', (0, 0), (-1, -1), 1, colors.black),&#10;        ('ROWBACKGROUNDS', (0, 1), (-1, -1), [colors.white, colors.HexColor('#f9f9f9')])&#10;    ]))&#10;    elements.append(items_table)&#10;    elements.append(Spacer(1, 0.2*inch))&#10;&#10;    # Order summary&#10;    elements.append(Paragraph(&quot;Order Summary&quot;, heading_style))&#10;&#10;    summary_data = [&#10;        ['Subtotal', '', f'₨{order.subtotal:.2f}'],&#10;        ['Shipping', f'({order.shipping_method.name if order.shipping_method else &quot;N/A&quot;})', f'₨{order.shipping_cost:.2f}'],&#10;        ['Tax', f'({order.tax_rate.name if order.tax_rate else &quot;N/A&quot;})', f'₨{order.tax_amount:.2f}'],&#10;        ['', '', ''],&#10;        ['TOTAL', '', f'₨{order.total_amount:.2f}'],&#10;    ]&#10;&#10;    summary_table = Table(summary_data, colWidths=[3*inch, 1.5*inch, 1.5*inch])&#10;    summary_table.setStyle(TableStyle([&#10;        ('ALIGN', (0, 0), (-1, -1), 'RIGHT'),&#10;        ('ALIGN', (0, 0), (0, -1), 'LEFT'),&#10;        ('FONTNAME', (0, 0), (-1, 3), 'Helvetica'),&#10;        ('FONTNAME', (0, 4), (-1, 4), 'Helvetica-Bold'),&#10;        ('FONTSIZE', (0, 4), (-1, 4), 12),&#10;        ('BACKGROUND', (0, 4), (-1, 4), colors.HexColor('#667eea')),&#10;        ('TEXTCOLOR', (0, 4), (-1, 4), colors.white),&#10;        ('BOTTOMPADDING', (0, 0), (-1, -1), 8),&#10;        ('GRID', (0, 0), (-1, -1), 1, colors.lightgrey)&#10;    ]))&#10;    elements.append(summary_table)&#10;    elements.append(Spacer(1, 0.3*inch))&#10;&#10;    # Footer&#10;    footer_style = ParagraphStyle(&#10;        'Footer',&#10;        parent=styles['Normal'],&#10;        fontSize=9,&#10;        textColor=colors.grey,&#10;        alignment=1&#10;    )&#10;    elements.append(Paragraph(&quot;Thank you for your purchase!&quot;, footer_style))&#10;    elements.append(Paragraph(&quot;For any queries, contact: support@order2wear.com&quot;, footer_style))&#10;    elements.append(Paragraph(&quot;Visit us: www.order2wear.com&quot;, footer_style))&#10;&#10;    # Build PDF&#10;    doc.build(elements)&#10;&#10;    # Return PDF&#10;    buffer.seek(0)&#10;    response = HttpResponse(buffer.getvalue(), content_type='application/pdf')&#10;    response['Content-Disposition'] = f'attachment; filename=&quot;invoice-{order.id}.pdf&quot;'&#10;    return response&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/templates/ecommerce/checkout.html">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/templates/ecommerce/checkout.html" />
              <option name="originalContent" value="{% extends 'base.html' %}&#10;&#10;{% block title %}Checkout - Order2Wear{% endblock %}&#10;&#10;{% block content %}&#10;&lt;div class=&quot;max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12&quot;&gt;&#10;    &lt;h1 class=&quot;text-4xl font-bold mb-8&quot;&gt;Checkout&lt;/h1&gt;&#10;&#10;    &lt;div class=&quot;grid grid-cols-1 lg:grid-cols-3 gap-8&quot;&gt;&#10;        &lt;!-- Checkout Form --&gt;&#10;        &lt;div class=&quot;lg:col-span-2&quot;&gt;&#10;            &lt;form method=&quot;post&quot; class=&quot;space-y-8&quot;&gt;&#10;                {% csrf_token %}&#10;&#10;                &lt;!-- Shipping Information --&gt;&#10;                &lt;div class=&quot;bg-white rounded-lg shadow-md p-6&quot;&gt;&#10;                    &lt;h2 class=&quot;text-2xl font-bold mb-6 flex items-center&quot;&gt;&#10;                        &lt;i class=&quot;fas fa-truck gradient-text mr-3&quot;&gt;&lt;/i&gt;Shipping Information&#10;                    &lt;/h2&gt;&#10;&#10;                    &lt;div class=&quot;space-y-4&quot;&gt;&#10;                        &lt;div class=&quot;grid grid-cols-1 md:grid-cols-2 gap-4&quot;&gt;&#10;                            &lt;div&gt;&#10;                                &lt;label for=&quot;first_name&quot; class=&quot;block text-sm font-semibold mb-2&quot;&gt;First Name *&lt;/label&gt;&#10;                                &lt;input type=&quot;text&quot; id=&quot;first_name&quot; name=&quot;first_name&quot; value=&quot;{{ user.first_name }}&quot; required class=&quot;w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500&quot;&gt;&#10;                            &lt;/div&gt;&#10;                            &lt;div&gt;&#10;                                &lt;label for=&quot;last_name&quot; class=&quot;block text-sm font-semibold mb-2&quot;&gt;Last Name *&lt;/label&gt;&#10;                                &lt;input type=&quot;text&quot; id=&quot;last_name&quot; name=&quot;last_name&quot; value=&quot;{{ user.last_name }}&quot; required class=&quot;w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500&quot;&gt;&#10;                            &lt;/div&gt;&#10;                        &lt;/div&gt;&#10;&#10;                        &lt;div&gt;&#10;                            &lt;label for=&quot;email&quot; class=&quot;block text-sm font-semibold mb-2&quot;&gt;Email *&lt;/label&gt;&#10;                            &lt;input type=&quot;email&quot; id=&quot;email&quot; name=&quot;email&quot; value=&quot;{{ user.email }}&quot; required class=&quot;w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500&quot;&gt;&#10;                        &lt;/div&gt;&#10;&#10;                        &lt;div&gt;&#10;                            &lt;label for=&quot;phone&quot; class=&quot;block text-sm font-semibold mb-2&quot;&gt;Phone Number *&lt;/label&gt;&#10;                            &lt;input type=&quot;tel&quot; id=&quot;phone&quot; name=&quot;phone&quot; value=&quot;{{ user_profile.phone }}&quot; required placeholder=&quot;03001234567&quot; class=&quot;w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500&quot;&gt;&#10;                        &lt;/div&gt;&#10;&#10;                        &lt;div&gt;&#10;                            &lt;label for=&quot;shipping_address&quot; class=&quot;block text-sm font-semibold mb-2&quot;&gt;Shipping Address *&lt;/label&gt;&#10;                            &lt;textarea id=&quot;shipping_address&quot; name=&quot;shipping_address&quot; required class=&quot;w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500&quot; rows=&quot;4&quot; placeholder=&quot;Enter your complete shipping address (e.g., House No. 123, Street Name, Area)&quot;&gt;{{ user_profile.address }}&lt;/textarea&gt;&#10;                        &lt;/div&gt;&#10;&#10;                        &lt;div class=&quot;grid grid-cols-1 md:grid-cols-2 gap-4&quot;&gt;&#10;                            &lt;div&gt;&#10;                                &lt;label for=&quot;city&quot; class=&quot;block text-sm font-semibold mb-2&quot;&gt;City *&lt;/label&gt;&#10;                                &lt;input type=&quot;text&quot; id=&quot;city&quot; name=&quot;city&quot; value=&quot;{{ user_profile.city }}&quot; required placeholder=&quot;e.g., Karachi&quot; class=&quot;w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500&quot;&gt;&#10;                            &lt;/div&gt;&#10;                            &lt;div&gt;&#10;                                &lt;label for=&quot;state&quot; class=&quot;block text-sm font-semibold mb-2&quot;&gt;State/Province *&lt;/label&gt;&#10;                                &lt;input type=&quot;text&quot; id=&quot;state&quot; name=&quot;state&quot; value=&quot;{{ user_profile.state }}&quot; required placeholder=&quot;e.g., Sindh&quot; class=&quot;w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500&quot;&gt;&#10;                            &lt;/div&gt;&#10;                        &lt;/div&gt;&#10;&#10;                        &lt;div class=&quot;grid grid-cols-1 md:grid-cols-2 gap-4&quot;&gt;&#10;                            &lt;div&gt;&#10;                                &lt;label for=&quot;postal_code&quot; class=&quot;block text-sm font-semibold mb-2&quot;&gt;Postal Code *&lt;/label&gt;&#10;                                &lt;input type=&quot;text&quot; id=&quot;postal_code&quot; name=&quot;postal_code&quot; value=&quot;{{ user_profile.postal_code }}&quot; required placeholder=&quot;e.g., 75600&quot; class=&quot;w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500&quot;&gt;&#10;                            &lt;/div&gt;&#10;                            &lt;div&gt;&#10;                                &lt;label for=&quot;country&quot; class=&quot;block text-sm font-semibold mb-2&quot;&gt;Country *&lt;/label&gt;&#10;                                &lt;input type=&quot;text&quot; id=&quot;country&quot; name=&quot;country&quot; value=&quot;{{ user_profile.country|default:'Pakistan' }}&quot; required placeholder=&quot;Pakistan&quot; class=&quot;w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500&quot;&gt;&#10;                            &lt;/div&gt;&#10;                        &lt;/div&gt;&#10;                    &lt;/div&gt;&#10;                &lt;/div&gt;&#10;&#10;                &lt;!-- Payment Method --&gt;&#10;                &lt;div class=&quot;bg-white rounded-lg shadow-md p-6&quot;&gt;&#10;                    &lt;h2 class=&quot;text-2xl font-bold mb-6 flex items-center&quot;&gt;&#10;                        &lt;i class=&quot;fas fa-credit-card gradient-text mr-3&quot;&gt;&lt;/i&gt;Payment Method&#10;                    &lt;/h2&gt;&#10;&#10;                    &lt;div class=&quot;space-y-4&quot;&gt;&#10;                        &lt;!-- Cash on Delivery (Enabled) --&gt;&#10;                        &lt;label class=&quot;flex items-center p-4 border-2 border-green-500 rounded-lg cursor-pointer bg-green-50 hover:shadow-md transition&quot;&gt;&#10;                            &lt;input type=&quot;radio&quot; name=&quot;payment_method&quot; value=&quot;cod&quot; checked class=&quot;mr-3 w-4 h-4&quot;&gt;&#10;                            &lt;div&gt;&#10;                                &lt;p class=&quot;font-semibold text-gray-800&quot;&gt; Cash on Delivery&lt;/p&gt;&#10;                                &lt;p class=&quot;text-sm text-gray-600&quot;&gt;Pay in cash when your order arrives at your doorstep&lt;/p&gt;&#10;                            &lt;/div&gt;&#10;                        &lt;/label&gt;&#10;&#10;                        &lt;!-- Standard Delivery (Enabled) --&gt;&#10;                        &lt;label class=&quot;flex items-center p-4 border-2 border-blue-500 rounded-lg cursor-pointer bg-blue-50 hover:shadow-md transition&quot;&gt;&#10;                            &lt;input type=&quot;radio&quot; name=&quot;payment_method&quot; value=&quot;bank_transfer&quot; class=&quot;mr-3 w-4 h-4&quot;&gt;&#10;                            &lt;div&gt;&#10;                                &lt;p class=&quot;font-semibold text-gray-800&quot;&gt; Bank Transfer&lt;/p&gt;&#10;                                &lt;p class=&quot;text-sm text-gray-600&quot;&gt;Transfer payment before delivery&lt;/p&gt;&#10;                            &lt;/div&gt;&#10;                        &lt;/label&gt;&#10;&#10;                        &lt;!-- Disabled Payment Methods Section --&gt;&#10;                        &lt;div class=&quot;bg-gray-100 rounded-lg p-4 border-2 border-dashed border-gray-300&quot;&gt;&#10;                            &lt;p class=&quot;text-sm font-semibold text-gray-600 mb-3&quot;&gt; Coming Soon&lt;/p&gt;&#10;&#10;                            &lt;!-- Credit Card (Disabled) --&gt;&#10;                            &lt;label class=&quot;flex items-center p-4 border-2 border-gray-300 rounded-lg cursor-not-allowed bg-gray-50 mb-3 opacity-60&quot;&gt;&#10;                                &lt;input type=&quot;radio&quot; name=&quot;payment_method&quot; value=&quot;card&quot; disabled class=&quot;mr-3 w-4 h-4&quot;&gt;&#10;                                &lt;div&gt;&#10;                                    &lt;p class=&quot;font-semibold text-gray-500&quot;&gt; Credit/Debit Card&lt;/p&gt;&#10;                                    &lt;p class=&quot;text-sm text-gray-400&quot;&gt;Visa, Mastercard, American Express&lt;/p&gt;&#10;                                &lt;/div&gt;&#10;                                &lt;span class=&quot;ml-auto text-xs font-semibold bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full&quot;&gt;Coming Soon&lt;/span&gt;&#10;                            &lt;/label&gt;&#10;&#10;                            &lt;!-- Digital Wallet (Disabled) --&gt;&#10;                            &lt;label class=&quot;flex items-center p-4 border-2 border-gray-300 rounded-lg cursor-not-allowed bg-gray-50 opacity-60&quot;&gt;&#10;                                &lt;input type=&quot;radio&quot; name=&quot;payment_method&quot; value=&quot;wallet&quot; disabled class=&quot;mr-3 w-4 h-4&quot;&gt;&#10;                                &lt;div&gt;&#10;                                    &lt;p class=&quot;font-semibold text-gray-500&quot;&gt; Digital Wallet&lt;/p&gt;&#10;                                    &lt;p class=&quot;text-sm text-gray-400&quot;&gt;Apple Pay, Google Pay, JazzCash, Easypaisa&lt;/p&gt;&#10;                                &lt;/div&gt;&#10;                                &lt;span class=&quot;ml-auto text-xs font-semibold bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full&quot;&gt;Coming Soon&lt;/span&gt;&#10;                            &lt;/label&gt;&#10;                        &lt;/div&gt;&#10;                    &lt;/div&gt;&#10;                &lt;/div&gt;&#10;&#10;                &lt;!-- Order Items Review --&gt;&#10;                &lt;div class=&quot;bg-white rounded-lg shadow-md p-6&quot;&gt;&#10;                    &lt;h2 class=&quot;text-2xl font-bold mb-6 flex items-center&quot;&gt;&#10;                        &lt;i class=&quot;fas fa-box gradient-text mr-3&quot;&gt;&lt;/i&gt;Order Summary&#10;                    &lt;/h2&gt;&#10;&#10;                    &lt;div class=&quot;space-y-4&quot;&gt;&#10;                        {% for item in cart.items.all %}&#10;                        &lt;div class=&quot;flex justify-between items-center pb-4 border-b&quot;&gt;&#10;                            &lt;div class=&quot;flex items-center gap-4&quot;&gt;&#10;                                {% if item.product.image %}&#10;                                    &lt;img src=&quot;{{ item.product.image.url }}&quot; alt=&quot;{{ item.product.name }}&quot; class=&quot;w-16 h-16 object-cover rounded&quot;&gt;&#10;                                {% else %}&#10;                                    &lt;div class=&quot;w-16 h-16 bg-gray-300 rounded flex items-center justify-center&quot;&gt;&#10;                                        &lt;i class=&quot;fas fa-image text-gray-400&quot;&gt;&lt;/i&gt;&#10;                                    &lt;/div&gt;&#10;                                {% endif %}&#10;                                &lt;div&gt;&#10;                                    &lt;p class=&quot;font-semibold text-gray-800&quot;&gt;{{ item.product.name }}&lt;/p&gt;&#10;                                    &lt;p class=&quot;text-sm text-gray-600&quot;&gt;Qty: {{ item.quantity }} x ₨{{ item.product.price }}&lt;/p&gt;&#10;                                &lt;/div&gt;&#10;                            &lt;/div&gt;&#10;                            &lt;p class=&quot;font-semibold text-lg&quot;&gt;₨{{ item.get_total }}&lt;/p&gt;&#10;                        &lt;/div&gt;&#10;                        {% endfor %}&#10;                    &lt;/div&gt;&#10;                &lt;/div&gt;&#10;&#10;                &lt;!-- Place Order Button --&gt;&#10;                &lt;button type=&quot;submit&quot; class=&quot;w-full gradient-bg text-white py-4 rounded-lg font-bold text-lg hover:shadow-lg smooth-transition&quot;&gt;&#10;                    &lt;i class=&quot;fas fa-check-circle mr-2&quot;&gt;&lt;/i&gt;Place Order Now&#10;                &lt;/button&gt;&#10;&#10;                &lt;a href=&quot;{% url 'ecommerce:cart' %}&quot; class=&quot;block text-center text-blue-600 hover:text-blue-800 font-semibold mt-4&quot;&gt;&#10;                    &lt;i class=&quot;fas fa-arrow-left mr-2&quot;&gt;&lt;/i&gt;Back to Cart&#10;                &lt;/a&gt;&#10;            &lt;/form&gt;&#10;        &lt;/div&gt;&#10;&#10;        &lt;!-- Order Summary Sidebar --&gt;&#10;        &lt;div&gt;&#10;            &lt;div class=&quot;bg-white rounded-lg shadow-lg p-6 sticky top-20 h-fit&quot;&gt;&#10;                &lt;h2 class=&quot;text-2xl font-bold mb-6&quot;&gt; Price Breakdown&lt;/h2&gt;&#10;&#10;                &lt;div class=&quot;space-y-4 border-b pb-6 mb-6&quot;&gt;&#10;                    &lt;div class=&quot;flex justify-between&quot;&gt;&#10;                        &lt;span class=&quot;text-gray-600&quot;&gt;Subtotal&lt;/span&gt;&#10;                        &lt;span class=&quot;font-semibold&quot;&gt;₨{{ subtotal }}&lt;/span&gt;&#10;                    &lt;/div&gt;&#10;&#10;                    {% if applied_coupon %}&#10;                    &lt;div class=&quot;flex justify-between text-green-600&quot;&gt;&#10;                        &lt;span&gt;Discount ({{ applied_coupon.code }})&lt;/span&gt;&#10;                        &lt;span class=&quot;font-semibold&quot;&gt;-₨{{ coupon_discount }}&lt;/span&gt;&#10;                    &lt;/div&gt;&#10;                    {% endif %}&#10;&#10;                    &lt;div class=&quot;flex justify-between&quot;&gt;&#10;                        &lt;span class=&quot;text-gray-600&quot;&gt;Shipping&lt;/span&gt;&#10;                        &lt;span class=&quot;font-semibold&quot;&gt;{% if shipping_method %}₨{{ shipping }} ({{ shipping_method.name }}){% else %}Not Set{% endif %}&lt;/span&gt;&#10;                    &lt;/div&gt;&#10;&#10;                    &lt;div class=&quot;flex justify-between&quot;&gt;&#10;                        &lt;span class=&quot;text-gray-600&quot;&gt;Tax&lt;/span&gt;&#10;                        &lt;span class=&quot;font-semibold&quot;&gt;{% if tax_rate %}₨{{ tax_amount }} ({{ tax_rate.name }} - {{ tax_rate.rate_percentage }}%){% else %}₨0.00{% endif %}&lt;/span&gt;&#10;                    &lt;/div&gt;&#10;                &lt;/div&gt;&#10;&#10;                &lt;div class=&quot;flex justify-between mb-6 text-xl font-bold&quot;&gt;&#10;                    &lt;span&gt;Total&lt;/span&gt;&#10;                    &lt;span class=&quot;gradient-text&quot;&gt;₨{{ total_amount }}&lt;/span&gt;&#10;                &lt;/div&gt;&#10;&#10;                &lt;!-- Promo Code --&gt;&#10;                &lt;div class=&quot;bg-gray-50 rounded-lg p-4 mb-6&quot;&gt;&#10;                    &lt;p class=&quot;text-sm font-semibold mb-3&quot;&gt;️ Have a Promo Code?&lt;/p&gt;&#10;                    {% if not applied_coupon %}&#10;                    &lt;form id=&quot;coupon-form&quot; class=&quot;flex gap-2&quot;&gt;&#10;                        {% csrf_token %}&#10;                        &lt;input type=&quot;text&quot; id=&quot;coupon_code&quot; name=&quot;coupon_code&quot; placeholder=&quot;Enter code&quot; class=&quot;flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm&quot; maxlength=&quot;50&quot;&gt;&#10;                        &lt;button type=&quot;button&quot; onclick=&quot;applyCoupon()&quot; class=&quot;gradient-bg text-white px-3 py-2 rounded-lg hover:shadow-lg smooth-transition text-sm font-semibold&quot;&gt;&#10;                            Apply&#10;                        &lt;/button&gt;&#10;                    &lt;/form&gt;&#10;                    {% else %}&#10;                    &lt;div class=&quot;flex justify-between items-center&quot;&gt;&#10;                        &lt;span class=&quot;text-sm font-semibold text-green-600&quot;&gt;✓ {{ applied_coupon.code }} applied&lt;/span&gt;&#10;                        &lt;button type=&quot;button&quot; onclick=&quot;removeCoupon()&quot; class=&quot;text-red-600 hover:text-red-800 text-sm font-semibold&quot;&gt;&#10;                            Remove&#10;                        &lt;/button&gt;&#10;                    &lt;/div&gt;&#10;                    {% endif %}&#10;                &lt;/div&gt;&#10;&#10;                &lt;!-- Guarantees --&gt;&#10;                &lt;div class=&quot;space-y-3 bg-blue-50 rounded-lg p-4&quot;&gt;&#10;                    &lt;div class=&quot;flex items-start space-x-3&quot;&gt;&#10;                        &lt;i class=&quot;fas fa-shield-alt text-blue-600 mt-1 text-sm&quot;&gt;&lt;/i&gt;&#10;                        &lt;div class=&quot;text-xs&quot;&gt;&#10;                            &lt;p class=&quot;font-semibold text-gray-800&quot;&gt;Secure Checkout&lt;/p&gt;&#10;                            &lt;p class=&quot;text-gray-600&quot;&gt;SSL encrypted payments&lt;/p&gt;&#10;                        &lt;/div&gt;&#10;                    &lt;/div&gt;&#10;                    &lt;div class=&quot;flex items-start space-x-3&quot;&gt;&#10;                        &lt;i class=&quot;fas fa-truck text-blue-600 mt-1 text-sm&quot;&gt;&lt;/i&gt;&#10;                        &lt;div class=&quot;text-xs&quot;&gt;&#10;                            &lt;p class=&quot;font-semibold text-gray-800&quot;&gt;Fast Shipping&lt;/p&gt;&#10;                            &lt;p class=&quot;text-gray-600&quot;&gt;2-3 business days&lt;/p&gt;&#10;                        &lt;/div&gt;&#10;                    &lt;/div&gt;&#10;                    &lt;div class=&quot;flex items-start space-x-3&quot;&gt;&#10;                        &lt;i class=&quot;fas fa-undo text-blue-600 mt-1 text-sm&quot;&gt;&lt;/i&gt;&#10;                        &lt;div class=&quot;text-xs&quot;&gt;&#10;                            &lt;p class=&quot;font-semibold text-gray-800&quot;&gt;Easy Returns&lt;/p&gt;&#10;                            &lt;p class=&quot;text-gray-600&quot;&gt;30-day return policy&lt;/p&gt;&#10;                        &lt;/div&gt;&#10;                    &lt;/div&gt;&#10;                &lt;/div&gt;&#10;            &lt;/div&gt;&#10;        &lt;/div&gt;&#10;    &lt;/div&gt;&#10;&lt;/div&gt;&#10;&#10;&lt;script&gt;&#10;function applyCoupon() {&#10;    const couponCode = document.getElementById('coupon_code').value.trim();&#10;&#10;    if (!couponCode) {&#10;        showNotification('Please enter a coupon code', 'error');&#10;        return;&#10;    }&#10;&#10;    // Get CSRF token from cookie&#10;    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;&#10;&#10;    fetch(&quot;{% url 'ecommerce:apply_coupon' %}&quot;, {&#10;        method: 'POST',&#10;        headers: {&#10;            'Content-Type': 'application/x-www-form-urlencoded',&#10;            'X-CSRFToken': csrftoken,&#10;            'X-Requested-With': 'XMLHttpRequest'&#10;        },&#10;        body: 'coupon_code=' + encodeURIComponent(couponCode)&#10;    })&#10;    .then(response =&gt; response.json())&#10;    .then(data =&gt; {&#10;        if (data.success) {&#10;            showNotification(data.message, 'success');&#10;            setTimeout(() =&gt; location.reload(), 1500);&#10;        } else {&#10;            showNotification(data.message, 'error');&#10;        }&#10;    })&#10;    .catch(error =&gt; {&#10;        console.error('Error:', error);&#10;        showNotification('Error applying coupon', 'error');&#10;    });&#10;}&#10;&#10;function removeCoupon() {&#10;    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;&#10;&#10;    fetch(&quot;{% url 'ecommerce:remove_coupon' %}&quot;, {&#10;        method: 'POST',&#10;        headers: {&#10;            'Content-Type': 'application/x-www-form-urlencoded',&#10;            'X-CSRFToken': csrftoken,&#10;            'X-Requested-With': 'XMLHttpRequest'&#10;        }&#10;    })&#10;    .then(response =&gt; response.json())&#10;    .then(data =&gt; {&#10;        if (data.success) {&#10;            showNotification(data.message, 'success');&#10;            setTimeout(() =&gt; location.reload(), 1500);&#10;        } else {&#10;            showNotification(data.message, 'error');&#10;        }&#10;    })&#10;    .catch(error =&gt; {&#10;        console.error('Error:', error);&#10;        showNotification('Error removing coupon', 'error');&#10;    });&#10;}&#10;&#10;function showNotification(message, type) {&#10;    const alertClass = type === 'success' ? 'bg-green-100 text-green-700 border-green-400' : 'bg-red-100 text-red-700 border-red-400';&#10;    const alertDiv = document.createElement('div');&#10;    alertDiv.className = 'fixed top-4 right-4 p-4 rounded border ' + alertClass + ' z-50';&#10;    alertDiv.innerHTML = '&lt;i class=&quot;fas fa-' + (type === 'success' ? 'check-circle' : 'exclamation-circle') + ' mr-2&quot;&gt;&lt;/i&gt;' + message;&#10;    document.body.appendChild(alertDiv);&#10;&#10;    setTimeout(() =&gt; alertDiv.remove(), 3000);&#10;}&#10;&lt;/script&gt;&#10;{% endblock %}&#10;&#10;" />
              <option name="updatedContent" value="{% extends 'base.html' %}&#10;&#10;{% block title %}Checkout - Order2Wear{% endblock %}&#10;&#10;{% block content %}&#10;&lt;div class=&quot;max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12&quot;&gt;&#10;    &lt;h1 class=&quot;text-4xl font-bold mb-8&quot;&gt;Checkout&lt;/h1&gt;&#10;&#10;    &lt;div class=&quot;grid grid-cols-1 lg:grid-cols-3 gap-8&quot;&gt;&#10;        &lt;!-- Checkout Form --&gt;&#10;        &lt;div class=&quot;lg:col-span-2&quot;&gt;&#10;            &lt;form method=&quot;post&quot; class=&quot;space-y-8&quot;&gt;&#10;                {% csrf_token %}&#10;&#10;                &lt;!-- Shipping Information --&gt;&#10;                &lt;div class=&quot;bg-white rounded-lg shadow-md p-6&quot;&gt;&#10;                    &lt;h2 class=&quot;text-2xl font-bold mb-6 flex items-center&quot;&gt;&#10;                        &lt;i class=&quot;fas fa-truck gradient-text mr-3&quot;&gt;&lt;/i&gt;Shipping Information&#10;                    &lt;/h2&gt;&#10;&#10;                    &lt;div class=&quot;space-y-4&quot;&gt;&#10;                        &lt;div class=&quot;grid grid-cols-1 md:grid-cols-2 gap-4&quot;&gt;&#10;                            &lt;div&gt;&#10;                                &lt;label for=&quot;first_name&quot; class=&quot;block text-sm font-semibold mb-2&quot;&gt;First Name *&lt;/label&gt;&#10;                                &lt;input type=&quot;text&quot; id=&quot;first_name&quot; name=&quot;first_name&quot; value=&quot;{{ user.first_name }}&quot; required class=&quot;w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500&quot;&gt;&#10;                            &lt;/div&gt;&#10;                            &lt;div&gt;&#10;                                &lt;label for=&quot;last_name&quot; class=&quot;block text-sm font-semibold mb-2&quot;&gt;Last Name *&lt;/label&gt;&#10;                                &lt;input type=&quot;text&quot; id=&quot;last_name&quot; name=&quot;last_name&quot; value=&quot;{{ user.last_name }}&quot; required class=&quot;w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500&quot;&gt;&#10;                            &lt;/div&gt;&#10;                        &lt;/div&gt;&#10;&#10;                        &lt;div&gt;&#10;                            &lt;label for=&quot;email&quot; class=&quot;block text-sm font-semibold mb-2&quot;&gt;Email *&lt;/label&gt;&#10;                            &lt;input type=&quot;email&quot; id=&quot;email&quot; name=&quot;email&quot; value=&quot;{{ user.email }}&quot; required class=&quot;w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500&quot;&gt;&#10;                        &lt;/div&gt;&#10;&#10;                        &lt;div&gt;&#10;                            &lt;label for=&quot;phone&quot; class=&quot;block text-sm font-semibold mb-2&quot;&gt;Phone Number *&lt;/label&gt;&#10;                            &lt;input type=&quot;tel&quot; id=&quot;phone&quot; name=&quot;phone&quot; value=&quot;{{ user_profile.phone }}&quot; required placeholder=&quot;03001234567&quot; class=&quot;w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500&quot;&gt;&#10;                        &lt;/div&gt;&#10;&#10;                        &lt;div&gt;&#10;                            &lt;label for=&quot;shipping_address&quot; class=&quot;block text-sm font-semibold mb-2&quot;&gt;Shipping Address *&lt;/label&gt;&#10;                            &lt;textarea id=&quot;shipping_address&quot; name=&quot;shipping_address&quot; required class=&quot;w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500&quot; rows=&quot;4&quot; placeholder=&quot;Enter your complete shipping address (e.g., House No. 123, Street Name, Area)&quot;&gt;{{ user_profile.address }}&lt;/textarea&gt;&#10;                        &lt;/div&gt;&#10;&#10;                        &lt;div class=&quot;grid grid-cols-1 md:grid-cols-2 gap-4&quot;&gt;&#10;                            &lt;div&gt;&#10;                                &lt;label for=&quot;city&quot; class=&quot;block text-sm font-semibold mb-2&quot;&gt;City *&lt;/label&gt;&#10;                                &lt;input type=&quot;text&quot; id=&quot;city&quot; name=&quot;city&quot; value=&quot;{{ user_profile.city }}&quot; required placeholder=&quot;e.g., Karachi&quot; class=&quot;w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500&quot;&gt;&#10;                            &lt;/div&gt;&#10;                            &lt;div&gt;&#10;                                &lt;label for=&quot;state&quot; class=&quot;block text-sm font-semibold mb-2&quot;&gt;State/Province *&lt;/label&gt;&#10;                                &lt;input type=&quot;text&quot; id=&quot;state&quot; name=&quot;state&quot; value=&quot;{{ user_profile.state }}&quot; required placeholder=&quot;e.g., Sindh&quot; class=&quot;w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500&quot;&gt;&#10;                            &lt;/div&gt;&#10;                        &lt;/div&gt;&#10;&#10;                        &lt;div class=&quot;grid grid-cols-1 md:grid-cols-2 gap-4&quot;&gt;&#10;                            &lt;div&gt;&#10;                                &lt;label for=&quot;postal_code&quot; class=&quot;block text-sm font-semibold mb-2&quot;&gt;Postal Code *&lt;/label&gt;&#10;                                &lt;input type=&quot;text&quot; id=&quot;postal_code&quot; name=&quot;postal_code&quot; value=&quot;{{ user_profile.postal_code }}&quot; required placeholder=&quot;e.g., 75600&quot; class=&quot;w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500&quot;&gt;&#10;                            &lt;/div&gt;&#10;                            &lt;div&gt;&#10;                                &lt;label for=&quot;country&quot; class=&quot;block text-sm font-semibold mb-2&quot;&gt;Country *&lt;/label&gt;&#10;                                &lt;input type=&quot;text&quot; id=&quot;country&quot; name=&quot;country&quot; value=&quot;{{ user_profile.country|default:'Pakistan' }}&quot; required placeholder=&quot;Pakistan&quot; class=&quot;w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500&quot;&gt;&#10;                            &lt;/div&gt;&#10;                        &lt;/div&gt;&#10;                    &lt;/div&gt;&#10;                &lt;/div&gt;&#10;&#10;                &lt;!-- Payment Method --&gt;&#10;                &lt;div class=&quot;bg-white rounded-lg shadow-md p-6&quot;&gt;&#10;                    &lt;h2 class=&quot;text-2xl font-bold mb-6 flex items-center&quot;&gt;&#10;                        &lt;i class=&quot;fas fa-credit-card gradient-text mr-3&quot;&gt;&lt;/i&gt;Payment Method&#10;                    &lt;/h2&gt;&#10;&#10;                    &lt;div class=&quot;space-y-4&quot;&gt;&#10;                        &lt;!-- Cash on Delivery (Enabled) --&gt;&#10;                        &lt;label class=&quot;flex items-center p-4 border-2 border-green-500 rounded-lg cursor-pointer bg-green-50 hover:shadow-md transition&quot;&gt;&#10;                            &lt;input type=&quot;radio&quot; name=&quot;payment_method&quot; value=&quot;cod&quot; checked class=&quot;mr-3 w-4 h-4&quot;&gt;&#10;                            &lt;div&gt;&#10;                                &lt;p class=&quot;font-semibold text-gray-800&quot;&gt; Cash on Delivery&lt;/p&gt;&#10;                                &lt;p class=&quot;text-sm text-gray-600&quot;&gt;Pay in cash when your order arrives at your doorstep&lt;/p&gt;&#10;                            &lt;/div&gt;&#10;                        &lt;/label&gt;&#10;&#10;                        &lt;!-- Disabled Payment Methods Section --&gt;&#10;                        &lt;div class=&quot;bg-gray-100 rounded-lg p-4 border-2 border-dashed border-gray-300&quot;&gt;&#10;                            &lt;p class=&quot;text-sm font-semibold text-gray-600 mb-3&quot;&gt; Coming Soon&lt;/p&gt;&#10;                            &#10;                            &lt;!-- Bank Transfer (Disabled) --&gt;&#10;                            &lt;label class=&quot;flex items-center p-4 border-2 border-gray-300 rounded-lg cursor-not-allowed bg-gray-50 mb-3 opacity-60&quot;&gt;&#10;                                &lt;input type=&quot;radio&quot; name=&quot;payment_method&quot; value=&quot;bank_transfer&quot; disabled class=&quot;mr-3 w-4 h-4&quot;&gt;&#10;                                &lt;div&gt;&#10;                                    &lt;p class=&quot;font-semibold text-gray-500&quot;&gt; Bank Transfer&lt;/p&gt;&#10;                                    &lt;p class=&quot;text-sm text-gray-400&quot;&gt;Transfer payment before delivery&lt;/p&gt;&#10;                                &lt;/div&gt;&#10;                                &lt;span class=&quot;ml-auto text-xs font-semibold bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full&quot;&gt;Coming Soon&lt;/span&gt;&#10;                            &lt;/label&gt;&#10;&#10;                            &lt;!-- Credit Card (Disabled) --&gt;&#10;                            &lt;label class=&quot;flex items-center p-4 border-2 border-gray-300 rounded-lg cursor-not-allowed bg-gray-50 mb-3 opacity-60&quot;&gt;&#10;                                &lt;input type=&quot;radio&quot; name=&quot;payment_method&quot; value=&quot;card&quot; disabled class=&quot;mr-3 w-4 h-4&quot;&gt;&#10;                                &lt;div&gt;&#10;                                    &lt;p class=&quot;font-semibold text-gray-500&quot;&gt; Credit/Debit Card&lt;/p&gt;&#10;                                    &lt;p class=&quot;text-sm text-gray-400&quot;&gt;Visa, Mastercard, American Express&lt;/p&gt;&#10;                                &lt;/div&gt;&#10;                                &lt;span class=&quot;ml-auto text-xs font-semibold bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full&quot;&gt;Coming Soon&lt;/span&gt;&#10;                            &lt;/label&gt;&#10;&#10;                            &lt;!-- Digital Wallet (Disabled) --&gt;&#10;                            &lt;label class=&quot;flex items-center p-4 border-2 border-gray-300 rounded-lg cursor-not-allowed bg-gray-50 opacity-60&quot;&gt;&#10;                                &lt;input type=&quot;radio&quot; name=&quot;payment_method&quot; value=&quot;wallet&quot; disabled class=&quot;mr-3 w-4 h-4&quot;&gt;&#10;                                &lt;div&gt;&#10;                                    &lt;p class=&quot;font-semibold text-gray-500&quot;&gt; Digital Wallet&lt;/p&gt;&#10;                                    &lt;p class=&quot;text-sm text-gray-400&quot;&gt;Apple Pay, Google Pay, JazzCash, Easypaisa&lt;/p&gt;&#10;                                &lt;/div&gt;&#10;                                &lt;span class=&quot;ml-auto text-xs font-semibold bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full&quot;&gt;Coming Soon&lt;/span&gt;&#10;                            &lt;/label&gt;&#10;                        &lt;/div&gt;&#10;                    &lt;/div&gt;&#10;                &lt;/div&gt;&#10;&#10;                &lt;!-- Order Items Review --&gt;&#10;                &lt;div class=&quot;bg-white rounded-lg shadow-md p-6&quot;&gt;&#10;                    &lt;h2 class=&quot;text-2xl font-bold mb-6 flex items-center&quot;&gt;&#10;                        &lt;i class=&quot;fas fa-box gradient-text mr-3&quot;&gt;&lt;/i&gt;Order Summary&#10;                    &lt;/h2&gt;&#10;&#10;                    &lt;div class=&quot;space-y-4&quot;&gt;&#10;                        {% for item in cart.items.all %}&#10;                        &lt;div class=&quot;flex justify-between items-center pb-4 border-b&quot;&gt;&#10;                            &lt;div class=&quot;flex items-center gap-4&quot;&gt;&#10;                                {% if item.product.image %}&#10;                                    &lt;img src=&quot;{{ item.product.image.url }}&quot; alt=&quot;{{ item.product.name }}&quot; class=&quot;w-16 h-16 object-cover rounded&quot;&gt;&#10;                                {% else %}&#10;                                    &lt;div class=&quot;w-16 h-16 bg-gray-300 rounded flex items-center justify-center&quot;&gt;&#10;                                        &lt;i class=&quot;fas fa-image text-gray-400&quot;&gt;&lt;/i&gt;&#10;                                    &lt;/div&gt;&#10;                                {% endif %}&#10;                                &lt;div&gt;&#10;                                    &lt;p class=&quot;font-semibold text-gray-800&quot;&gt;{{ item.product.name }}&lt;/p&gt;&#10;                                    &lt;p class=&quot;text-sm text-gray-600&quot;&gt;Qty: {{ item.quantity }} x ₨{{ item.product.price }}&lt;/p&gt;&#10;                                &lt;/div&gt;&#10;                            &lt;/div&gt;&#10;                            &lt;p class=&quot;font-semibold text-lg&quot;&gt;₨{{ item.get_total }}&lt;/p&gt;&#10;                        &lt;/div&gt;&#10;                        {% endfor %}&#10;                    &lt;/div&gt;&#10;                &lt;/div&gt;&#10;&#10;                &lt;!-- Place Order Button --&gt;&#10;                &lt;button type=&quot;submit&quot; class=&quot;w-full gradient-bg text-white py-4 rounded-lg font-bold text-lg hover:shadow-lg smooth-transition&quot;&gt;&#10;                    &lt;i class=&quot;fas fa-check-circle mr-2&quot;&gt;&lt;/i&gt;Place Order Now&#10;                &lt;/button&gt;&#10;&#10;                &lt;a href=&quot;{% url 'ecommerce:cart' %}&quot; class=&quot;block text-center text-blue-600 hover:text-blue-800 font-semibold mt-4&quot;&gt;&#10;                    &lt;i class=&quot;fas fa-arrow-left mr-2&quot;&gt;&lt;/i&gt;Back to Cart&#10;                &lt;/a&gt;&#10;            &lt;/form&gt;&#10;        &lt;/div&gt;&#10;&#10;        &lt;!-- Order Summary Sidebar --&gt;&#10;        &lt;div&gt;&#10;            &lt;div class=&quot;bg-white rounded-lg shadow-lg p-6 sticky top-20 h-fit&quot;&gt;&#10;                &lt;h2 class=&quot;text-2xl font-bold mb-6&quot;&gt; Price Breakdown&lt;/h2&gt;&#10;&#10;                &lt;div class=&quot;space-y-4 border-b pb-6 mb-6&quot;&gt;&#10;                    &lt;div class=&quot;flex justify-between&quot;&gt;&#10;                        &lt;span class=&quot;text-gray-600&quot;&gt;Subtotal&lt;/span&gt;&#10;                        &lt;span class=&quot;font-semibold&quot;&gt;₨{{ subtotal }}&lt;/span&gt;&#10;                    &lt;/div&gt;&#10;&#10;                    {% if applied_coupon %}&#10;                    &lt;div class=&quot;flex justify-between text-green-600&quot;&gt;&#10;                        &lt;span&gt;Discount ({{ applied_coupon.code }})&lt;/span&gt;&#10;                        &lt;span class=&quot;font-semibold&quot;&gt;-₨{{ coupon_discount }}&lt;/span&gt;&#10;                    &lt;/div&gt;&#10;                    {% endif %}&#10;&#10;                    &lt;div class=&quot;flex justify-between&quot;&gt;&#10;                        &lt;span class=&quot;text-gray-600&quot;&gt;Shipping&lt;/span&gt;&#10;                        &lt;span class=&quot;font-semibold&quot;&gt;{% if shipping_method %}₨{{ shipping }} ({{ shipping_method.name }}){% else %}Not Set{% endif %}&lt;/span&gt;&#10;                    &lt;/div&gt;&#10;&#10;                    &lt;div class=&quot;flex justify-between&quot;&gt;&#10;                        &lt;span class=&quot;text-gray-600&quot;&gt;Tax&lt;/span&gt;&#10;                        &lt;span class=&quot;font-semibold&quot;&gt;{% if tax_rate %}₨{{ tax_amount }} ({{ tax_rate.name }} - {{ tax_rate.rate_percentage }}%){% else %}₨0.00{% endif %}&lt;/span&gt;&#10;                    &lt;/div&gt;&#10;                &lt;/div&gt;&#10;&#10;                &lt;div class=&quot;flex justify-between mb-6 text-xl font-bold&quot;&gt;&#10;                    &lt;span&gt;Total&lt;/span&gt;&#10;                    &lt;span class=&quot;gradient-text&quot;&gt;₨{{ total_amount }}&lt;/span&gt;&#10;                &lt;/div&gt;&#10;&#10;                &lt;!-- Promo Code --&gt;&#10;                &lt;div class=&quot;bg-gray-50 rounded-lg p-4 mb-6&quot;&gt;&#10;                    &lt;p class=&quot;text-sm font-semibold mb-3&quot;&gt;️ Have a Promo Code?&lt;/p&gt;&#10;                    {% if not applied_coupon %}&#10;                    &lt;form id=&quot;coupon-form&quot; class=&quot;flex gap-2&quot;&gt;&#10;                        {% csrf_token %}&#10;                        &lt;input type=&quot;text&quot; id=&quot;coupon_code&quot; name=&quot;coupon_code&quot; placeholder=&quot;Enter code&quot; class=&quot;flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm&quot; maxlength=&quot;50&quot;&gt;&#10;                        &lt;button type=&quot;button&quot; onclick=&quot;applyCoupon()&quot; class=&quot;gradient-bg text-white px-3 py-2 rounded-lg hover:shadow-lg smooth-transition text-sm font-semibold&quot;&gt;&#10;                            Apply&#10;                        &lt;/button&gt;&#10;                    &lt;/form&gt;&#10;                    {% else %}&#10;                    &lt;div class=&quot;flex justify-between items-center&quot;&gt;&#10;                        &lt;span class=&quot;text-sm font-semibold text-green-600&quot;&gt;✓ {{ applied_coupon.code }} applied&lt;/span&gt;&#10;                        &lt;button type=&quot;button&quot; onclick=&quot;removeCoupon()&quot; class=&quot;text-red-600 hover:text-red-800 text-sm font-semibold&quot;&gt;&#10;                            Remove&#10;                        &lt;/button&gt;&#10;                    &lt;/div&gt;&#10;                    {% endif %}&#10;                &lt;/div&gt;&#10;&#10;                &lt;!-- Guarantees --&gt;&#10;                &lt;div class=&quot;space-y-3 bg-blue-50 rounded-lg p-4&quot;&gt;&#10;                    &lt;div class=&quot;flex items-start space-x-3&quot;&gt;&#10;                        &lt;i class=&quot;fas fa-shield-alt text-blue-600 mt-1 text-sm&quot;&gt;&lt;/i&gt;&#10;                        &lt;div class=&quot;text-xs&quot;&gt;&#10;                            &lt;p class=&quot;font-semibold text-gray-800&quot;&gt;Secure Checkout&lt;/p&gt;&#10;                            &lt;p class=&quot;text-gray-600&quot;&gt;SSL encrypted payments&lt;/p&gt;&#10;                        &lt;/div&gt;&#10;                    &lt;/div&gt;&#10;                    &lt;div class=&quot;flex items-start space-x-3&quot;&gt;&#10;                        &lt;i class=&quot;fas fa-truck text-blue-600 mt-1 text-sm&quot;&gt;&lt;/i&gt;&#10;                        &lt;div class=&quot;text-xs&quot;&gt;&#10;                            &lt;p class=&quot;font-semibold text-gray-800&quot;&gt;Fast Shipping&lt;/p&gt;&#10;                            &lt;p class=&quot;text-gray-600&quot;&gt;2-3 business days&lt;/p&gt;&#10;                        &lt;/div&gt;&#10;                    &lt;/div&gt;&#10;                    &lt;div class=&quot;flex items-start space-x-3&quot;&gt;&#10;                        &lt;i class=&quot;fas fa-undo text-blue-600 mt-1 text-sm&quot;&gt;&lt;/i&gt;&#10;                        &lt;div class=&quot;text-xs&quot;&gt;&#10;                            &lt;p class=&quot;font-semibold text-gray-800&quot;&gt;Easy Returns&lt;/p&gt;&#10;                            &lt;p class=&quot;text-gray-600&quot;&gt;30-day return policy&lt;/p&gt;&#10;                        &lt;/div&gt;&#10;                    &lt;/div&gt;&#10;                &lt;/div&gt;&#10;            &lt;/div&gt;&#10;        &lt;/div&gt;&#10;    &lt;/div&gt;&#10;&lt;/div&gt;&#10;&#10;&lt;script&gt;&#10;function applyCoupon() {&#10;    const couponCode = document.getElementById('coupon_code').value.trim();&#10;&#10;    if (!couponCode) {&#10;        showNotification('Please enter a coupon code', 'error');&#10;        return;&#10;    }&#10;&#10;    // Get CSRF token from cookie&#10;    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;&#10;&#10;    fetch(&quot;{% url 'ecommerce:apply_coupon' %}&quot;, {&#10;        method: 'POST',&#10;        headers: {&#10;            'Content-Type': 'application/x-www-form-urlencoded',&#10;            'X-CSRFToken': csrftoken,&#10;            'X-Requested-With': 'XMLHttpRequest'&#10;        },&#10;        body: 'coupon_code=' + encodeURIComponent(couponCode)&#10;    })&#10;    .then(response =&gt; response.json())&#10;    .then(data =&gt; {&#10;        if (data.success) {&#10;            showNotification(data.message, 'success');&#10;            setTimeout(() =&gt; location.reload(), 1500);&#10;        } else {&#10;            showNotification(data.message, 'error');&#10;        }&#10;    })&#10;    .catch(error =&gt; {&#10;        console.error('Error:', error);&#10;        showNotification('Error applying coupon', 'error');&#10;    });&#10;}&#10;&#10;function removeCoupon() {&#10;    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;&#10;&#10;    fetch(&quot;{% url 'ecommerce:remove_coupon' %}&quot;, {&#10;        method: 'POST',&#10;        headers: {&#10;            'Content-Type': 'application/x-www-form-urlencoded',&#10;            'X-CSRFToken': csrftoken,&#10;            'X-Requested-With': 'XMLHttpRequest'&#10;        }&#10;    })&#10;    .then(response =&gt; response.json())&#10;    .then(data =&gt; {&#10;        if (data.success) {&#10;            showNotification(data.message, 'success');&#10;            setTimeout(() =&gt; location.reload(), 1500);&#10;        } else {&#10;            showNotification(data.message, 'error');&#10;        }&#10;    })&#10;    .catch(error =&gt; {&#10;        console.error('Error:', error);&#10;        showNotification('Error removing coupon', 'error');&#10;    });&#10;}&#10;&#10;function showNotification(message, type) {&#10;    const alertClass = type === 'success' ? 'bg-green-100 text-green-700 border-green-400' : 'bg-red-100 text-red-700 border-red-400';&#10;    const alertDiv = document.createElement('div');&#10;    alertDiv.className = 'fixed top-4 right-4 p-4 rounded border ' + alertClass + ' z-50';&#10;    alertDiv.innerHTML = '&lt;i class=&quot;fas fa-' + (type === 'success' ? 'check-circle' : 'exclamation-circle') + ' mr-2&quot;&gt;&lt;/i&gt;' + message;&#10;    document.body.appendChild(alertDiv);&#10;&#10;    setTimeout(() =&gt; alertDiv.remove(), 3000);&#10;}&#10;&lt;/script&gt;&#10;{% endblock %}&#10;&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>